# Cryptocurrency Arbitrage Ratio Analyzer

High-performance analyzer for identifying mean-reverting price ratios between exchanges. This tool uses event-based opportunity cycle detection to find profitable arbitrage patterns based on deviations from price parity (1.0).

## Concept

The analyzer calculates the price ratio between two exchanges (`ratio = exchange1_bid / exchange2_bid`) and analyzes its percentage deviation from `1.0`. A deviation of `0%` signifies that prices are equal, representing a break-even point for an arbitrage trade.

The primary goal is to find pairs that exhibit strong **mean-reversion**: their price ratio consistently oscillates around `1.0`, creating frequent, predictable opportunities for arbitrage.

Key metrics include:
- **Mean reversion frequency** (zero crossings per minute).
- **Complete opportunity cycles** (periods when deviation exceeds a profitable threshold and then returns to a near-zero neutral zone).
- **Deviation asymmetry** (to detect one-sided price bias).

## Key Features & Optimizations

This script is heavily optimized for speed:
- **Batch Processing by Symbol**: Loads data for a symbol once, then analyzes all its exchange pairs.
- **Parallel Exchange Loading**: Uses a `ThreadPoolExecutor` for concurrent I/O when loading data for different exchanges.
- **Single Parquet Scan**: Reads all required data for a symbol in one efficient operation.
- **Pure Polars Operations**: All calculations are done using Polars for zero-copy data manipulation, avoiding slower NumPy conversions.
- **Filter Pushdown**: Filters out null values early in the process to reduce computational load.
- **Optimized Data Types**: Casts decimals to `Float64` for faster calculations.
- **Batch Threshold Calculation**: Analyzes all profitability thresholds (`0.3%`, `0.4%`, `0.5%`) in a single pass.

## Usage

### Basic Command
To run the analysis on all available data:
```bash
python run_all_ultra.py
```

### Command-Line Arguments

| Argument | Type | Description |
|--------------|------------|------------------------------------------------------------------------------------------|
| `--workers` | integer | Number of parallel workers (default: 3x CPU cores). |
| `--today` | flag | Shortcut to analyze only today's data. |
| `--date` | YYYY-MM-DD | Analyze a specific date (shortcut for `--start-date=DATE --end-date=DATE`). |
| `--start-date` | YYYY-MM-DD | Start date for analysis (inclusive). |
| `--end-date` | YYYY-MM-DD | End date for analysis (inclusive). |

### Usage Examples

**1. Analyze only today's data:**
```bash
python run_all_ultra.py --today
```

**2. Analyze a specific date:**
```bash
python run_all_ultra.py --date 2025-11-02
```

**3. Analyze a date range:**
```bash
python run_all_ultra.py --start-date 2025-11-01 --end-date 2025-11-03
```

**4. Analyze from a specific date onwards:**
```bash
python run_all_ultra.py --start-date 2025-11-02
```

**5. Analyze with a custom number of workers:**
```bash
python run_all_ultra.py --workers 16 --today
```

## Output

The script produces two main outputs:

### 1. Console Summary
Two top-10 lists are printed:
- **Top 10 by Mean Reversion Frequency**: Pairs with the highest `zero_crossings_per_minute`, indicating strong mean-reverting behavior.
- **Top 10 by COMPLETE Cycles**: **(Most important for traders)** Pairs with the highest number of actual, tradeable arbitrage opportunities.

### 2. CSV Report
A detailed report named `summary_stats_YYYYMMDD_HHMMSS.csv` is saved with all calculated metrics for every pair.

## Metrics Explained

These metrics have been rigorously validated and corrected.

| Metric | Formula & Explanation | Why It's Important |
|---------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Deviation (%)** | `((ratio - 1.0) / 1.0) * 100` <br> Measures deviation from price parity (1.0). A value of 0 means prices are equal. | This is the core indicator of an arbitrage opportunity. It directly shows the potential profit margin before fees. |
| **Complete Opportunity Cycles** | A cycle is counted only when the deviation: <br> 1. Was above a threshold (e.g., 0.4%) <br> 2. And then **returned to the neutral zone** (`abs(deviation) < 0.05%`). | This is the most critical metric for traders as it counts **real, closeable opportunities**, filtering out periods where the price spread gets stuck. |
| **Zero Crossings per Minute** | `(sign(dev) * sign(dev.shift(1)) < 0).sum() / duration_minutes` <br> Counts how often the deviation crosses the 0% mark, indicating a true sign flip. | A high value signifies strong, symmetric mean-reversion, which is the ideal characteristic of a stable arbitrage pair. |
| **Deviation Asymmetry** | `mean(deviation)` <br> The average deviation over the period. | A value near 0 indicates symmetric oscillation. A high positive or negative value reveals a **directional bias**, making it risky to trade as the price may not return to zero. |
| **`cycles_..._per_hour`** | `opportunity_cycles / duration_hours` <br> Normalizes the cycle count over time. | Allows for fair comparison of opportunity frequency between pairs, regardless of the analysis duration. |
| **`pct_time_above_...`** | `mean(abs(deviation) > threshold) * 100` <br> Percentage of time the deviation was wider than the threshold. | Must be analyzed **together with cycle count**. High `pct_time` with low `cycles` indicates a stuck, untradeable spread. |
| **`avg_cycle_duration_..._sec`** | `(total_time_above_threshold_sec) / opportunity_cycles` <br> Average duration of a single opportunity in seconds. | Helps estimate how quickly a position needs to be opened and closed. Short durations (<60s) are for bots; longer durations (1-5min) can be handled manually. |

## How to Identify Good Trading Pairs

Look for a combination of high opportunity frequency and low directional bias.

### ✅ Ideal Pair
- **`cycles_040bp_per_hour` > 5**: Frequent, profitable opportunities.
- **`zero_crossings_per_minute` > 0.2**: Strong mean-reversion.
- **`abs(deviation_asymmetry)` < 0.3**: Low bias, prices reliably return to parity.
- **`avg_cycle_duration_040bp_sec`**: Between 30 and 300 seconds (tradeable window).

### ❌ Bad Pair (High Risk)
- **`cycles_040bp_per_hour` < 2**: Very few real opportunities.
- **`zero_crossings_per_minute` < 0.05**: Trending, not mean-reverting.
- **`abs(deviation_asymmetry)` > 0.8**: Strong bias, high risk of the spread never closing.

**Recommendation**: Focus on the **"Top 10 by COMPLETE cycles"** list in the console output. It is the most reliable indicator of tradeable pairs.

## Data Structure

The script expects data to be stored in a partitioned format:
`../data/market_data/exchange={EXCHANGE_NAME}/symbol={SYMBOL_NAME}/date={YYYY-MM-DD}/hour={HH}/*.parquet`