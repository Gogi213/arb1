# Детальное описание метрик и алгоритмов (`analyze_pair_fast`)

Этот документ подробно описывает, как вычисляются ключевые метрики в функции `analyze_pair_fast`, которая является ядром анализатора.

## 1. Синхронизация и базовое отклонение

1.  **Синхронизация (`join_asof`):**
    *   Данные из двух бирж (`data1`, `data2`) синхронизируются по времени. Для каждой строки в `data1` находится ближайшая по времени (но не позднее) строка в `data2`. Это создает единый `DataFrame` с колонками `bid_ex1`, `ask_ex1`, `bid_ex2`, `ask_ex2`.

2.  **Расчет `ratio` (соотношение):**
    *   Создается новая колонка `ratio`, которая вычисляется как `bid_ex1 / bid_ex2`. Это показывает, во сколько раз цена на одной бирже отличается от цены на другой.

3.  **Расчет `deviation` (отклонение):**
    *   **Формула:** `(ratio - 1.0) * 100`.
    *   **Обоснование:** Это ключевой шаг. Отклонение измеряется от `1.0` (паритет цен), а не от среднего значения `ratio`. Это гарантирует, что `deviation = 0` означает равенство цен, то есть возможность закрыть арбитражную сделку без потерь. Результат выражается в процентах.

## 2. Метрики возврата к среднему

Эти метрики оценивают, насколько часто и стабильно цена возвращается к состоянию равновесия (`deviation = 0`).

### `zero_crossings` (Пересечения нуля)

*   **Цель:** Посчитать, сколько раз `deviation` переходит из положительной зоны в отрицательную и наоборот.
*   **Алгоритм:**
    1.  Вычисляется знак отклонения для каждой точки: `pl.col('deviation').sign()`.
    2.  Этот ряд сдвигается на одну позицию: `deviation_sign.shift(1)`.
    3.  Два ряда перемножаются. Если результат отрицательный (`< 0`), это означает, что знаки были разными (например, `+1` и `-1`), то есть произошло пересечение нуля.
    4.  Суммируется количество таких пересечений.
*   **Метрики:** `zero_crossings_per_hour` и `zero_crossings_per_minute` — общее количество пересечений, нормализованное на длительность временного ряда.

### `deviation_asymmetry` (Асимметрия отклонения)

*   **Цель:** Определить, есть ли постоянный перекос цены одной биржи относительно другой.
*   **Алгоритм:** Рассчитывается как среднее значение `deviation` (`mean_deviation_pct`).
*   **Интерпретация:**
    *   Если `asymmetry` близка к `0`, это означает, что отклонение симметрично колеблется вокруг нуля (идеальный случай для mean-reversion).
    *   Если `asymmetry` значительно отличается от нуля (например, `> 0.2`), это говорит о том, что цена на одной бирже систематически выше, чем на другой.

## 3. Метрики торговых возможностей

Эти метрики оценивают количество и качество потенциально прибыльных сделок.

### `opportunity_cycles` (Циклы возможностей)

*   **Цель:** Посчитать количество *полных, торгуемых* арбитражных циклов.
*   **Определение "полного цикла":**
    1.  Абсолютное значение `deviation` превышает заданный порог (например, `0.4%`). Это точка *потенциального* входа в сделку.
    2.  После этого `deviation` возвращается в "нейтральную зону" (например, `abs(deviation) < 0.05%`). Это точка, где сделку можно закрыть без потерь или с минимальной прибылью.
*   **Алгоритм (`count_complete_cycles`):**
    1.  Создаются два булевых массива: `above` (истина, если `abs(deviation) > threshold`) и `neutral` (истина, если `abs(deviation) < ZERO_THRESHOLD`).
    2.  Алгоритм итерирует по этим массивам, используя флаг `was_above`.
    3.  Если `above[i]` истинно, флаг `was_above` устанавливается в `True`.
    4.  Если `neutral[i]` истинно **и** флаг `was_above` уже установлен, это означает завершение цикла. Счетчик циклов увеличивается, а флаг `was_above` сбрасывается в `False`, чтобы ждать следующего выхода за порог.
*   **Обоснование:** Такой подход позволяет отфильтровать "ложные" возможности, где цена вышла за порог, но так и не вернулась к паритету, не дав возможности закрыть сделку.

### Дополнительные метрики циклов

*   `cycles_..._per_hour`: Количество циклов, нормализованное на час.
*   `pct_time_above_...`: Процент времени, которое `deviation` проводит за пределами порога.
*   `avg_cycle_duration_..._sec`: Средняя продолжительность нахождения цены за порогом в рамках одного цикла.
*   `pattern_break_...`: Булев флаг, который становится `True`, если на момент окончания данных `deviation` все еще находится за пределами порога. Это может указывать на смену рыночного режима ("слом паттерна").