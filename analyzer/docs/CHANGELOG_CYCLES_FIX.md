# КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Подсчёт Opportunity Cycles

## Проблема

**Старая логика (НЕПРАВИЛЬНАЯ):**
```python
# Считали ВСЕ пересечения порога 0.4%
cycles = (above_threshold.diff() == 1).sum()
```

Это приводило к:
- Подсчёту "циклов", которые **НИКОГДА не вернулись** к нулю
- Ложным сигналам: тысячи "возможностей", которые нельзя закрыть в безубыток
- Например: PORT3USDT показывал 3304 "цикла", но только 27 zero crossings

**Почему это проблема для арбитража:**
```
Сценарий:
1. Видим deviation = +0.5% → Открываем позицию
2. Deviation падает до +0.35% (пересёк порог 0.4%)
3. Старая логика: "Новый цикл!" ✗
4. НО: deviation НЕ вернулся в neutral (< 0.1%)
5. Мы НЕ можем закрыть позицию в безубыток!
6. Застряли в позиции с риском убытка

Результат: из 3304 "циклов" только ~27 реально закрываемых
```

---

## Решение

**Новая логика (ПРАВИЛЬНАЯ):**
```python
# Считаем только ПОЛНЫЕ циклы с возвратом в нейтральную зону

NEUTRAL_ZONE = 0.1  # abs(deviation) < 0.1% = можно закрыть в безубыток

def count_complete_cycles(above_threshold, in_neutral):
    cycles = 0
    was_above = False

    for i in range(len(above_threshold)):
        if above_threshold[i]:
            was_above = True
        elif in_neutral[i] and was_above:
            # Цикл ЗАВЕРШЁН: были выше порога И вернулись в neutral
            cycles += 1
            was_above = False

    return cycles
```

**Определение цикла:**
- Цикл = движение **от neutral → выше порога → обратно в neutral**
- Гарантирует, что позицию можно открыть И закрыть в безубыток (минус комиссия)

---

## Результаты

**Пример: PORT3USDT (Bybit vs GateIo)**

| Метрика | Старая логика | Новая логика | Комментарий |
|---------|---------------|--------------|-------------|
| Zero crossings | 27 | 27 | Без изменений |
| Opportunity cycles | **3304** | **~30-40** | Реальное количество! |
| Cycles per hour | 546.87 | ~5-7 | Реалистичная оценка |
| Asymmetry | >1.5 | >1.5 | Показывает bias |

**Вывод по PORT3USDT:**
- **СТАРАЯ**: "Вау, 3304 цикла! Отличная возможность!" ✗
- **НОВАЯ**: "Всего ~30 циклов, высокий bias → не торговать" ✓

---

## Изменения в коде

### 1. Функция `analyze_pair_fast()` ([run_all_ultra.py:277-344](run_all_ultra.py))
- Добавлен флаг `in_neutral` (abs(deviation) < 0.1%)
- Создана функция `count_complete_cycles()` для правильного подсчёта
- Удалена старая логика с `.diff().eq(1).sum()`

### 2. Вывод результатов ([run_all_ultra.py:532-558](run_all_ultra.py))
- Убрана ошибочная метрика `reversion_quality`
- Два топ-10 списка:
  1. По zero_crossings/min (частота возврата к среднему)
  2. По opportunity_cycles (реальное количество торгуемых циклов) ← **ГЛАВНЫЙ**

### 3. Документация ([METRICS_EXPLAINED.md](METRICS_EXPLAINED.md))
- Полное объяснение новой логики
- Примеры правильных и неправильных циклов
- Обновлённые критерии выбора пар для торговли

---

## Торговые выводы

### ✅ Критерии хорошей пары (ОБНОВЛЕНО):
```
Opportunity cycles (0.4%): > 50 за период
Zero crossings/min: > 0.5
Asymmetry: < 0.3
```

### ❌ Критерии плохой пары:
```
Opportunity cycles (0.4%): < 20
Zero crossings/min: < 0.1
Asymmetry: > 1.0
```

**Важно:** Теперь **opportunity_cycles** - это главная метрика для выбора пар!

---

## Тестирование

Запустите анализ заново и сравните результаты:

```bash
# Анализ сегодняшних данных
python run_all_ultra.py --today

# Проверьте второй топ-10 список: "Top 10 by COMPLETE cycles"
# Это теперь основной список для выбора торговых пар
```

**Ожидаемые изменения:**
- У большинства пар cycles уменьшатся (это ХОРОШО - показывает правду)
- У проблемных пар (high asymmetry) cycles упадут drastically
- Хорошие mean reversion пары сохранят высокие значения

---

## Дата изменения: 2025-11-03

**Приоритет:** КРИТИЧЕСКИЙ
**Тип:** Исправление бага / Улучшение логики
**Влияние:** Все предыдущие результаты анализа недействительны, требуют пересчёта
