# Объяснение метрик анализатора

## Основные метрики

### 1. Zero Crossings (Пересечения нуля)
**Что измеряет:** Количество раз, когда deviation пересекает 0% (среднее значение)

**Формула:** Подсчёт смены знака deviation

**Почему важно:**
- Каждое пересечение нуля = потенциальная точка закрытия позиции "в безубыток"
- Высокое значение = цена часто возвращается к среднему (true mean reversion)
- Низкое значение = цена редко возвращается к среднему (возможен bias)

**Пример:**
```
+1% ----▲----
 0% ====X====X====X====  <- 3 zero crossings
-1% ----▼----
```

---

### 2. Opportunity Cycles (Циклы возможностей) - ИСПРАВЛЕНО
**Что измеряет:** Количество ПОЛНЫХ циклов с возвратом в нейтральную зону

**Правильное определение:**
- **Цикл** = движение от нейтральной зоны (abs(deviation) < 0.1%) → выше порога (abs(deviation) > 0.4%) → обратно в нейтральную зону
- Это гарантирует, что позицию можно закрыть в безубыток (минус комиссия)

**Формула:**
```python
Считаем возвраты в neutral ПОСЛЕ того, как были выше порога:
- Был выше порога? was_above = True
- Вернулся в neutral И was_above = True? cycles++, was_above = False
```

**Почему важно:**
- Показывает РЕАЛЬНОЕ количество торгуемых возможностей
- Каждый цикл = можно открыть И закрыть позицию
- Фильтрует "застревания" выше/ниже среднего

**Правильный пример:**
```
+0.5% ----▲---------▲----
+0.4% ====|=========|====  <- Выше порога 2 раза
+0.1% ----┘----┐----┘----  <- Вернулись в neutral 2 раза
 0.0% ---------└---------  <- Может не пересечь ноль!
                            ИТОГО: 2 полных цикла ✓
```

**Неправильный пример (старая логика):**
```
+0.6% ----▲----▼----▲----▼----
+0.4% ====X====X====X====X====  <- Пересекли порог 4 раза
+0.2% ---------------------------
 0.0% ---------------------------  <- НИ РАЗУ не вернулись в neutral!
                                   Старая логика: 4 цикла ✗
                                   Новая логика: 0 циклов ✓
```

---

### 3. Deviation Asymmetry (Асимметрия отклонений)
**Что измеряет:** Насколько отклонения смещены в одну сторону

**Формула:**
```python
asymmetry = (max_deviation + min_deviation) / (max_deviation - min_deviation)
```

**Интерпретация:**
- **≈ 0**: Симметричные колебания (хороший mean reversion)
  - Пример: max=+1%, min=-1% → asymmetry = 0
- **> +0.3**: Позитивный bias (цена обычно выше среднего)
  - Пример: max=+0.8%, min=+0.2% → asymmetry = +1.67
- **< -0.3**: Негативный bias (цена обычно ниже среднего)
  - Пример: max=-0.2%, min=-0.8% → asymmetry = -1.67

**Почему важно:**
Высокая асимметрия означает, что **цена не возвращается к нулю** для безубыточного закрытия позиции.

**Визуализация:**

**Симметричный (asymmetry ≈ 0) - ХОРОШО:**
```
+1.0% ----▲----
 0.0% ====X====X====X====
-1.0% ----▼----
```

**Асимметричный (asymmetry > 1.0) - ПЛОХО:**
```
+0.8% ----▲----▼----▲----
+0.2% --------------------  <- Минимум НЕ достигает нуля
 0.0% ----X---------------  <- Редкие возвраты к нулю
-0.2% --------------------
```

---

### 4. Связь между Zero Crossings и Opportunity Cycles

**Правильное понимание:**

С новой логикой подсчёта циклов:
- **opportunity_cycles ≤ zero_crossings** (почти всегда)
- Цикл требует возврата в нейтральную зону, но не обязательно пересечение нуля
- Zero crossing более "строгий" - требует смены знака deviation

**Примеры:**

**Пример 1: Симметричный mean reversion**
```
Zero crossings: 6354
Opportunity cycles (0.4%): 4500
Asymmetry: 0.05

Интерпретация: Отличный mean reversion.
Большинство циклов завершаются пересечением нуля.
```

**Пример 2: Проблемная пара (СТАРАЯ логика показала бы)**
```
СТАРАЯ логика (НЕПРАВИЛЬНО):
- Opportunity cycles: 3304
- Zero crossings: 27
- Ratio: 122 цикла на 1 возврат к нулю → НЕ торговать!

НОВАЯ логика (ПРАВИЛЬНО):
- Opportunity cycles: ~30-50 (только полные циклы с возвратом)
- Zero crossings: 27
- Это соответствует реальности - мало возможностей
```

**Вывод:**
Теперь **не нужна** отдельная метрика "quality" - сам подсчёт циклов уже учитывает качество!

---

## Торговые выводы

### ✅ Идеальная пара для арбитража:
```
Opportunity cycles (0.4%): > 50 за период
Zero crossings/min: > 0.5
Asymmetry: < 0.3
Cycles/hour: > 10
```
**Почему:** Много полных циклов, частые возвраты к среднему, низкий bias

### ⚠️ Приемлемо - но нужен осторожный подход:
```
Opportunity cycles (0.4%): 20-50
Zero crossings/min: 0.2 - 0.5
Asymmetry: 0.3 - 0.7
```
**Почему:** Умеренное количество возможностей, есть небольшой bias

### ❌ НЕ подходит для арбитража:
```
Opportunity cycles (0.4%): < 20
Zero crossings/min: < 0.1
Asymmetry: > 1.0
```
**Почему:** Мало полных циклов, редкие возвраты к нулю, сильный bias - риск застрять в позиции

---

## Пример анализа проблемной пары

**PORT3USDT (Bybit vs GateIo) - СТАРАЯ логика:**
```
СТАРЫЕ РЕЗУЛЬТАТЫ (НЕПРАВИЛЬНЫЕ):
Zero crossings: 27
Opportunity cycles 0.4%: 3304  <- ОШИБКА! Считались все пересечения порога
Cycles per hour: 546.87
% Time above 0.4%: 36.69%
Asymmetry: > 1.5
```

**НОВАЯ логика (ПРАВИЛЬНАЯ):**
```
Zero crossings: 27
Opportunity cycles 0.4%: ~30-40  <- Только полные циклы с возвратом в neutral!
Cycles per hour: ~5-7
% Time above 0.4%: 36.69%
Asymmetry: > 1.5
```

**Проблема теперь очевидна:**
1. **Мало полных циклов** (~30 вместо 3304)
2. Низкая частота (~5-7/час вместо 546/час)
3. Высокая asymmetry > 1.5 → сильный bias
4. Цена редко возвращается в нейтральную зону

**Сценарий торговли:**
```
СТАРАЯ логика обманывала:
- Видели 3304 "цикла" → "Вау, много возможностей!"
- На деле: 3277 из них НЕ вернулись к нулю
- Реальных возможностей: только ~30

НОВАЯ логика показывает правду:
- ~30 полных циклов за период
- Это соответствует 27 zero crossings
- Правильная оценка: МАЛО возможностей
```

**Вывод:** НЕ торговать! Мало возможностей + сильный bias = высокий риск.

---

## Использование в анализаторе

Теперь анализатор выводит **два топ-10 списка**:

1. **Top 10 by mean reversion frequency** - сортировка по zero_crossings/min
   - Самые активные пары по частоте возврата к среднему
   - Показывает общую "живость" пары

2. **Top 10 by COMPLETE cycles** - сортировка по opportunity_cycles
   - **Лучшие пары для арбитража**
   - Показывает реальное количество торгуемых возможностей
   - Учитывает только циклы с возвратом в нейтральную зону
   - **Рекомендуется использовать этот список!**

## Дополнительные метрики в CSV

CSV файл содержит все метрики для детального анализа:
- `max_deviation_pct`, `min_deviation_pct` - диапазон отклонений
- `pattern_break_030bp`, `pattern_break_040bp` - флаги возможного разрыва паттерна
- `avg_cycle_duration_XXXbp_sec` - средняя продолжительность цикла в секундах
- `data_points` - количество точек данных
- `duration_hours` - общая продолжительность анализа
