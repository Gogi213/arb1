# Полный анализ метрик анализатора (2025-11-03)

## Цель
Доёбчиво проверить ВСЕ метрики после критических исправлений:
- Исправление расчёта deviation (от 1.0 вместо mean_ratio)
- Исправление подсчёта циклов (только полные циклы с возвратом в neutral)

## Методология
Каждая метрика проверена через sequential thinking на логическую корректность и применимость к реальной торговле.

---

## ✅ ПРАВИЛЬНЫЕ МЕТРИКИ

### 1. Deviation Calculation
```python
deviation = (ratio - 1.0) / 1.0 * 100
```

**Почему правильно:**
- deviation = 0 означает ratio = 1.0 (цены равны)
- Можно закрыть позицию в безубыток (минус комиссия)
- Измеряет отклонение от ЦЕНОВОГО ПАРИТЕТА, а не от среднего

**Применение:**
- Положительное deviation: Exchange 1 дороже → покупать на Ex2, продавать на Ex1
- Отрицательное deviation: Exchange 2 дороже → покупать на Ex1, продавать на Ex2

---

### 2. max_deviation_pct и min_deviation_pct

**Что измеряют:**
- max_deviation_pct: Максимальная прибыль при покупке на Ex2, продаже на Ex1
- min_deviation_pct: Максимальная прибыль при покупке на Ex1, продаже на Ex2

**Пример:**
```
max_deviation_pct = +0.8%  → Ex1 был на 0.8% дороже (макс. возможность)
min_deviation_pct = -0.3%  → Ex2 был на 0.3% дороже (макс. возможность)
```

**Применение:**
- Показывают ДИАПАЗОН возможностей
- Если max и min близки по модулю → симметричный mean reversion
- Если один намного больше → directional bias

---

### 3. Asymmetry (mean_deviation_pct)

```python
asymmetry = mean(deviation)
```

**Что измеряет:**
- Среднее отклонение от паритета (1.0)
- Показывает directional bias

**Интерпретация:**
- asymmetry ≈ 0: Симметричные колебания вокруг паритета (хорошо)
- asymmetry > +0.2%: Ex1 обычно дороже (позитивный bias)
- asymmetry < -0.2%: Ex2 обычно дороже (негативный bias)

**Торговый вывод:**
Высокая asymmetry → цена редко возвращается к нулю → сложно закрыть в безубыток

---

### 4. ZERO_THRESHOLD = 0.05%

**Определение:**
Deviation считается "в нейтральной зоне" если abs(deviation) < 0.05%

**Обоснование:**
- 0.05% = 5 basis points = очень близко к паритету
- ratio в диапазоне [0.9995, 1.0005]
- Достаточно мало, чтобы считать "цены почти равны"
- Учитывает шум данных (цены никогда не бывают ТОЧНО равны)

**Применение:**
Используется в подсчёте полных циклов:
- Цикл = neutral → выше порога → обратно в neutral
- Гарантирует, что позицию можно закрыть близко к безубытку

---

### 5. Threshold Levels (0.3%, 0.4%, 0.5%)

**Обоснование выбора:**

**Торговые издержки:**
- Maker fee: ~0.02% - 0.05%
- Taker fee: ~0.05% - 0.1%
- Round-trip: 0.04% - 0.2%
- Slippage: 0.02% - 0.1%

**Интерпретация порогов:**
- **0.3%**: Минимальный порог для taker-taker арбитража (едва прибыльно)
  - Девиация 0.3% - комиссии 0.2% - slippage 0.05% = 0.05% чистая прибыль
- **0.4%**: Консервативный порог с запасом на slippage
  - Девиация 0.4% - издержки 0.25% = 0.15% чистая прибыль
- **0.5%**: Высокодоходные возможности
  - Девиация 0.5% - издержки 0.25% = 0.25% чистая прибыль

**Зачем три порога?**
Разные трейдеры имеют разные издержки (VIP tier, maker rebates) и толерантность к риску.

---

### 6. opportunity_cycles_XXXbp

**Правильное определение (ИСПРАВЛЕНО):**
Цикл = движение от neutral (< 0.05%) → выше порога → обратно в neutral

```python
def count_complete_cycles(above_threshold, in_neutral):
    cycles = 0
    was_above = False
    for i in range(len(above_threshold)):
        if above_threshold[i]:
            was_above = True
        elif in_neutral[i] and was_above:
            cycles += 1
            was_above = False
    return cycles
```

**Почему правильно:**
- Считает только ПОЛНЫЕ циклы, которые вернулись к нулю
- Каждый цикл = реальная торговая возможность
- Фильтрует "застревания" выше/ниже среднего

**Ключевое отличие от старой логики:**
- СТАРАЯ: Считала ВСЕ пересечения порога (включая незавершённые)
- НОВАЯ: Считает только циклы с ВОЗВРАТОМ в neutral

---

### 7. cycles_XXXbp_per_hour

```python
cycles_per_hour = cycles / duration_hours
```

**Почему критически важно:**
- Нормализация по времени для сравнения разных периодов
- **ГЛАВНАЯ МЕТРИКА** для выбора торговых пар
- Показывает частоту реальных возможностей

**Применение:**
```
Пара A: 100 циклов за 10 часов = 10 циклов/час
Пара B: 20 циклов за 2 часа = 10 циклов/час
→ Одинаковая частота возможностей
```

**Критерии отбора:**
- Отлично: > 10 циклов/час (0.4% порог)
- Хорошо: 5-10 циклов/час
- Приемлемо: 2-5 циклов/час
- Плохо: < 2 циклов/час

---

### 8. avg_cycle_duration_XXXbp_sec

```python
avg_duration = (duration_hours * pct_time_above / 100 * 3600) / cycles
```

**Что измеряет:**
Среднее время, проведённое ВЫШЕ порога за один цикл

**Формула:**
- total_time_above = общее время выше порога
- total_time_above / cycles = среднее время за цикл

**Применение:**
- Короткая длительность (< 60 сек): Нужно быстрое исполнение, высокочастотная торговля
- Средняя длительность (1-5 мин): Подходит для ручной торговли
- Долгая длительность (> 10 мин): Медленные возможности, риск изменения условий

---

### 9. pct_time_above_XXXbp

```python
pct_time_above = mean(deviation.abs() > threshold) * 100
```

**Что измеряет:**
Процент времени, когда abs(deviation) выше порога

**ВАЖНО: Нужен контекст!**

Высокий процент может означать:
- **ХОРОШО**: Частые осцилляции (много циклов)
- **ПЛОХО**: Застревание выше порога (мало циклов)

**Правильная интерпретация:**
```
pct_time_above = 40%, cycles = 100 → Много быстрых циклов ✓
pct_time_above = 40%, cycles = 5   → Застревание, bias ✗
```

Всегда смотреть вместе с opportunity_cycles!

---

### 10. zero_crossings (ИСПРАВЛЕНО)

**Старая логика (БАГОВАННАЯ):**
```python
zero_crossings = (deviation.sign().diff().abs() > 0).sum()
```

**Проблема:**
Считала переход через ноль как ДВА события:
```
deviation: +0.2 → 0.0 → -0.2
sign:      [+1,    0,   -1]
diff:      [NaN,  -1,   -1]
abs>0:     [False, True, True]
sum:       2  ← НЕПРАВИЛЬНО!
```

**Новая логика (ПРАВИЛЬНАЯ):**
```python
deviation_sign = pl.col('deviation').sign()
zero_crossings = (deviation_sign * deviation_sign.shift(1) < 0).sum()
```

**Почему правильно:**
- sign[i] * sign[i-1] < 0 только когда (+1 → -1) или (-1 → +1)
- Игнорирует переходы через точный ноль
- Считает только истинные смены знака

**Практическое влияние:**
Баг проявляется редко (цены редко ТОЧНО равны), но логика теперь корректна.

---

### 11. zero_crossings_per_hour / per_minute

```python
zero_crossings_per_hour = zero_crossings / duration_hours
zero_crossings_per_minute = zero_crossings_per_hour / 60
```

**Назначение:**
Нормализация для сравнения разных периодов

**Применение:**
- Высокая частота (> 1/мин): Активный mean reversion
- Средняя частота (0.1-1/мин): Умеренный mean reversion
- Низкая частота (< 0.1/мин): Слабый mean reversion, возможен bias

---

### 12. data_points и duration_hours

**Метаданные анализа:**
- data_points: Количество временных меток
- duration_hours: Длительность периода

**Применение:**
- Проверка качества данных: data_points / duration_hours = частота сэмплирования
- Статистическая уверенность: больше точек = надёжнее результаты
- Минимум для надёжного анализа: > 1000 точек, > 1 час

---

## ❌ НЕ ПОЛЕЗНАЯ МЕТРИКА

### pattern_break_XXXbp

```python
last_deviation = float(joined['deviation'][-1])
pattern_break_040bp = abs(last_deviation) > 0.4
```

**Что делает:**
Проверяет, выше ли deviation порога в ПОСЛЕДНЕЙ точке данных

**Почему не полезно:**
- Это просто snapshot конца временного окна
- Не показывает тренд или изменение паттерна
- Если анализируем вчерашние данные, "последняя" точка произвольна

**Пример бесполезности:**
```
Анализируем данные за вчера (00:00 - 23:59)
pattern_break_040bp = True

Что это означает?
- В 23:59 deviation был > 0.4%
- Это может быть начало нового цикла
- Или конец цикла
- Или случайный момент
→ Нет полезной информации!
```

**Что было бы полезнее:**
- Частота циклов в первой vs второй половине периода
- Максимальное время непрерывного пребывания выше порога
- Тренд изменения asymmetry

**Решение:**
Оставить в коде (чтобы не ломать CSV), но не использовать для принятия решений.

---

## ИТОГОВЫЕ ВЫВОДЫ

### Критические исправления выполнены:
1. ✅ deviation теперь от 1.0 (price parity), а не от mean_ratio
2. ✅ opportunity_cycles считает только полные циклы с возвратом
3. ✅ zero_crossings исправлен (умножение вместо diff)
4. ✅ asymmetry правильно измеряет bias от нуля

### Все основные метрики валидированы:
- 12 метрик признаны ПРАВИЛЬНЫМИ и ПОЛЕЗНЫМИ
- 1 баг найден и исправлен (zero_crossings)
- 1 метрика признана бесполезной (pattern_break)

### Рекомендации по использованию:

**Главные метрики для выбора пар:**
1. `cycles_040bp_per_hour` - частота возможностей (КЛЮЧЕВАЯ)
2. `zero_crossings_per_minute` - частота mean reversion
3. `deviation_asymmetry` - проверка на bias
4. `avg_cycle_duration_040bp_sec` - оценка скорости исполнения

**Критерии хорошей пары:**
```
cycles_040bp_per_hour > 5
zero_crossings_per_minute > 0.2
abs(deviation_asymmetry) < 0.3
avg_cycle_duration_040bp_sec: 30-300 (30 сек - 5 мин)
```

**Критерии плохой пары:**
```
cycles_040bp_per_hour < 2
zero_crossings_per_minute < 0.05
abs(deviation_asymmetry) > 0.8
```

---

## Дата проверки: 2025-11-03
**Статус:** ВСЕ МЕТРИКИ ПРОВЕРЕНЫ ✓
**Приоритет:** ВЫСОКИЙ
**Следующий шаг:** Запустить анализ с исправленным кодом
