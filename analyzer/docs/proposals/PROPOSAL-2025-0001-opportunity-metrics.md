# PROPOSAL-2025-0001: Уточнение метрик возможностей

## Диагностика
Текущая метрика `opportunities` в `docs/FORMULAS.md` подсчитывает общее количество точек данных (тиков), где спред превышает заданный порог. Это приводит к неверной интерпретации, особенно для трендовых пар. Пара, у которой спред один раз расширился и почти никогда не сужался, показывает огромное значение `opportunities`, создавая ложное впечатление о большом количестве арбитражных возможностей. На самом деле, это была всего одна, но очень длинная возможность.

Пользователь справедливо указал на это расхождение: "на 1 crossing может быть 1 opportunities". Это подчеркивает необходимость различать *события* возникновения возможностей и *длительность* нахождения в этом состоянии.

## Предлагаемое изменение
Внести следующие концептуальные изменения в `docs/FORMULAS.md`:

1.  **Переименовать существующую метрику:**
    *   Везде в документе заменить `Opportunities` на `Opportunity Data Points` или `Opportunity Ticks`.
    *   Например, `opportunities_per_hour` станет `opportunity_ticks_per_hour`.
    *   Это изменение ясно укажет, что метрика считает точки данных, а не события.

2.  **Ввести новую метрику "События-возможности" (`Opportunity Events`):**
    *   Добавить новый раздел, описывающий `Opportunity Events`.
    *   **Определение:** Событие-возможность — это момент, когда `deviation` пересекает пороговое значение, входя в зону прибыльности.
    *   **Алгоритм:**
        ```python
        # 1. Создать булеву маску, где отклонение выше порога
        is_above_threshold = abs(deviation) > threshold
        # 2. Сравнить с предыдущим состоянием, чтобы найти только входы в зону
        opportunity_events = sum(is_above_threshold & ~is_above_threshold.shift(1, fill_value=False))
        ```
    *   Ввести производные метрики:
        *   `opportunity_events_per_hour`: Частота возникновения новых возможностей.
        *   `avg_opportunity_duration_ticks`: Средняя длительность одной возможности (`opportunity_ticks / opportunity_events`).

3.  **Обновить сводные таблицы и правила фильтрации:**
    *   Включить новые метрики (`opportunity_events_per_hour`, `avg_opportunity_duration_ticks`) в анализ.
    *   Обновить правила, чтобы они использовали `opportunity_events` для более точной оценки частоты возникновения возможностей, а не их общей длительности.

## Обоснование
Это изменение устранит двусмысленность и сделает анализ более точным и интуитивно понятным. Новые метрики позволят четко отделить частоту возникновения возможностей от их средней продолжительности, что является ключевым для HFT-стратегий. Анализ станет более устойчивым к трендовым парам, которые ранее могли быть неверно классифицированы как "хорошие".

## Оценка рисков
Риски минимальны, так как изменения затрагивают только документацию. Основной "риск" — необходимость для аналитика ознакомиться с новыми, более точными метриками, что является положительным результатом.

## План тестирования
Неприменимо для изменения документации. Валидация заключается в рассмотрении и утверждении данного предложения.

## План отката
В случае отклонения предложения или необходимости отката, достаточно удалить этот файл и не вносить изменения в `docs/FORMULAS.md`. Если изменения будут внесены, откат производится командой `git checkout docs/FORMULAS.md`.