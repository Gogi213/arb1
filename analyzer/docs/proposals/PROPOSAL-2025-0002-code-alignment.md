# PROPOSAL-2025-0002: Приведение кода в соответствие с документацией метрик

## Диагностика
Анализ файла `ratio_analyzer.py` показал, что его логика не соответствует обновленной методологии, описанной в `docs/FORMULAS.md` (v2.1).

Ключевые расхождения:
1.  **Неверный расчет `opportunities_per_hour`**: Код использует простой `total_opportunities / duration_hours`, что в документации явно помечено как неверный подход. Правильный метод — усреднение по сгруппированным часовым данным (`mean(hourly_counts)`).
2.  **Отсутствие ключевых метрик**: В коде не реализованы важнейшие новые метрики:
    *   `opportunity_events` (подсчет событий входа в зону возможности).
    *   `avg_opportunity_duration_ticks` (средняя длительность возможности).
3.  **Устаревшая терминология**: В коде, возвращаемом словаре и функции `print_summary` используются старые названия (`opportunities`, `opportunities_per_hour`), что вызывает путаницу.
4.  **Небольшое расхождение в алгоритме `zero_crossings`**: Используется `np.roll` вместо более стандартного `np.diff`.

## Предлагаемое изменение
Внести изменения в `ratio_analyzer.py` для полного приведения в соответствие с `docs/FORMULAS.md`.

1.  **Исправить расчет `opportunity_ticks_per_hour`**:
    *   В методе `finalize` после чтения CSV-файла добавить колонку `hour`.
    *   Сгруппировать данные по этой колонке и рассчитать `opportunity_ticks_per_hour` как среднее значение по часовым суммам.

2.  **Добавить новые метрики**:
    *   Создать новый приватный метод `_count_opportunity_events(deviation: np.ndarray, threshold: float) -> int`, который реализует алгоритм `(is_above & ~is_above.shift(1)).sum()`.
    *   В `finalize` вызвать этот метод для подсчета `opportunity_events`.
    *   Рассчитать `avg_opportunity_duration_ticks` на основе `total_opportunity_ticks` и `opportunity_events`.

3.  **Обновить названия переменных и ключей**:
    *   Переименовать `num_opportunities` в `total_opportunity_ticks`.
    *   В возвращаемом словаре и `print_summary` заменить `opportunities_03pct` на `opportunity_ticks_03pct`, `opportunities_per_hour` на `opportunity_ticks_per_hour` и добавить новые метрики (`opportunity_events_03pct`, `avg_opportunity_duration_ticks_03pct` и т.д.).

4.  **Унифицировать `_count_zero_crossings`**:
    *   Изменить алгоритм на `np.sum(np.diff(signs) != 0)` для соответствия документации и большей ясности.

## Обоснование
Эти изменения критически важны для обеспечения того, чтобы генерируемые отчеты были точными и соответствовали утвержденной, более надежной методологии. Исправление расчета `opportunity_ticks_per_hour` и добавление новых метрик позволит проводить более глубокий и корректный анализ арбитражных пар, отсеивая "плохие" трендовые пары, которые ранее могли быть неверно классифицированы.

## Оценка рисков
- **Изменение результатов**: Результаты анализа для существующих данных изменятся. Это ожидаемо и является целью исправления, так как старые расчеты были неточными.
- **Сложность**: Изменение `finalize` для группировки по часам потребует осторожной работы с `polars.DataFrame`, но является стандартной операцией.

## План тестирования
1.  Подготовить небольшой тестовый CSV-файл (10-20 строк) с известными переходами через порог и ноль.
2.  Запустить обновленный `ratio_analyzer.py` на этом файле.
3.  Сравнить значения метрик (`opportunity_events`, `opportunity_ticks_per_hour`, `zero_crossings`) в итоговом отчете с ожидаемыми, рассчитанными вручную.

## План отката
`git checkout ratio_analyzer.py`