# PROPOSAL-2025-0003: Внедрение анализа пиковых значений для событий-возможностей

## Диагностика
Текущая реализация анализа (`PROPOSAL-2025-0002`) позволяет считать количество и среднюю длительность событий-возможностей. Однако, она не дает информации о "качестве" или "силе" этих событий. Мы не можем отличить ситуацию с 1000 событий, пик которых едва превысил 0.3%, от ситуации с 1000 событий, пики которых в среднем достигали 0.8%. Эта информация критически важна для оценки реальной прибыльности торговой пары.

## Предлагаемое изменение
Внедрить в `docs/FORMULAS.md` и, впоследствии, в `ratio_analyzer.py` новую, более глубокую методологию анализа, основанную на пиковых значениях каждого события.

1.  **Определить новую сущность: "Пик События" (`Event Peak`)**
    *   Это максимальное абсолютное значение `deviation_pct`, достигнутое в течение одного `Opportunity Event` (от момента пересечения порога до возврата обратно).

2.  **Описать новый алгоритм:**
    *   Для временного ряда `deviation_pct` идентифицируются группы последовательных значений, превышающих порог. Каждая такая группа является событием.
    *   Для каждой группы находится максимальное значение.
    *   Все эти пиковые значения собираются в список `event_peaks`.

3.  **Ввести новые метрики в документацию:**
    *   `event_peaks`: Список всех пиковых значений.
    *   `avg_event_peak_pct`: Среднее значение пиков событий.
    *   `max_event_peak_pct`: Максимальный пик среди всех событий.
    *   `event_peak_distribution`: Распределение пиков по категориям. Это ключевая метрика, которая будет показывать, сколько событий попало в каждую "корзину":
        *   `peaks_03_05_pct`: Количество событий с пиком в диапазоне [0.3%, 0.5%)
        *   `peaks_05_10_pct`: Количество событий с пиком в диапазоне [0.5%, 1.0%)
        *   `peaks_10_plus_pct`: Количество событий с пиком > 1.0%

## Обоснование
Это изменение переводит анализ с простого подсчета событий на оценку их качества. Распределение пиков позволит:
-   **Точно оценивать прибыльность:** Можно будет видеть, генерирует ли пара в основном "слабые" или "сильные" сигналы.
-   **Улучшить фильтрацию пар:** Появятся новые критерии для отбора, например: "искать пары, у которых не менее 20% событий имеют пик > 0.5%".
-   **Принимать более обоснованные решения:** Анализ станет значительно глубже и будет давать более полное представление о поведении торгового инструмента.

## Оценка рисков
- **Сложность реализации**: Алгоритм поиска пиков для каждой группы последовательных значений сложнее, чем просто подсчет. Он потребует итерации или использования специализированных функций `polars` для работы с группами.
- **Производительность**: На очень больших наборах данных этот расчет может быть медленнее, чем предыдущие метрики. Однако, так как он выполняется один раз в методе `finalize`, влияние на общую производительность должно быть приемлемым.

## План тестирования
1.  **Документация:** После утверждения, внести изменения в `docs/FORMULAS.md`.
2.  **Код:**
    *   Создать `PROPOSAL-2025-0004` для реализации в коде.
    *   Реализовать алгоритм в `ratio_analyzer.py`.
    *   Подготовить тестовый CSV-файл с несколькими четко выраженными событиями и их пиками.
    *   Запустить анализатор и проверить, что `event_peak_distribution` и другие метрики рассчитаны корректно.

## План отката
`git checkout docs/FORMULAS.md` и `git checkout ratio_analyzer.py`.