# Описание рабочего процесса проекта Analyzer

Скрипт `run_all_ultra.py` предназначен для быстрого и эффективного анализа арбитражных возможностей между различными криптовалютными биржами. Вот пошаговое описание его работы:

### 1. Запуск и настройка

- **Запуск:** Процесс начинается с запуска скрипта `run_all_ultra.py` из командной строки.
- **Параметры:** При запуске можно указать дополнительные параметры:
  - `--date ГГГГ-ММ-ДД`: для анализа данных за конкретный день.
  - `--start-date` и `--end-date`: для анализа данных в определенном диапазоне дат.
  - `--workers N`: для указания количества параллельных процессов (по умолчанию используется количество ядер процессора, умноженное на 3).
- **Режим по умолчанию:** Если никакие даты не указаны, скрипт анализирует все доступные данные.

### 2. Поиск данных для анализа

- **Сканирование директории:** Скрипт запускает функцию `discover_data`, которая сканирует основную директорию с данными (`../data/market_data`).
- **Группировка по символам:** Он находит все `.parquet` файлы, сгруппированные по биржам и торговым символам (например, `BTC/USDT`).
- **Отбор пар:** Для дальнейшего анализа отбираются только те символы, которые торгуются как минимум на двух разных биржах, так как арбитраж возможен только между парами.

### 3. Подготовка к параллельному анализу

- **Создание задач:** Для каждого отобранного символа формируется "задача". Эта задача включает в себя имя символа и список бирж, на которых он доступен.
- **Создание пула воркеров:** Скрипт инициализирует пул процессов (`multiprocessing.Pool`) для выполнения анализа параллельно, что значительно ускоряет обработку больших объемов данных.

### 4. Параллельный анализ (основная логика)

- **Распределение задач:** Пул воркеров получает список задач, и каждый воркер берет на себя обработку одного символа.
- **Выполнение `analyze_symbol_batch`:** Внутри каждого воркера выполняется эта функция, которая делает следующее:
  1. **Параллельная загрузка данных:** С помощью `ThreadPoolExecutor` данные по одному символу загружаются одновременно со всех нужных бирж. Это ускоряет операции ввода-вывода.
  2. **Анализ пар:** После загрузки данных создаются комбинации бирж (пары, например, `Binance` vs `Bybit`). Для каждой такой пары вызывается функция `analyze_pair_fast`.
  3. **Синхронизация и расчеты (`analyze_pair_fast`):**
     - Данные от двух бирж синхронизируются по времени с помощью `join_asof`.
     - Рассчитывается процентное отклонение (спред) между ценами.
     - Вычисляются ключевые метрики:
       - **Пересечения нуля (Zero Crossings):** Как часто спред возвращается к нулю, что указывает на частоту колебаний.
       - **Арбитражные циклы:** Сколько раз спред превышал заданные пороги (например, 0.3%, 0.5%), а затем возвращался к нулю. Это показывает количество реальных торговых возможностей.
       - **Асимметрия:** Есть ли постоянный перекос в ценах в сторону одной из бирж.

### 5. Сбор результатов и отчет

- **Агрегация:** Основной процесс собирает результаты анализа от всех воркеров.
- **Сохранение в CSV:** Если анализ прошел успешно, все собранные статистические данные сохраняются в CSV-файл с уникальным именем, включающим текущую дату и время (например, `summary_stats_20251104_050631.csv`).
- **Вывод в консоль:** Скрипт выводит в консоль две таблицы "Топ-10":
  1. Лучшие пары по частоте пересечения нуля (самые "волатильные" спреды).
  2. Лучшие пары по количеству полных арбитражных циклов (наибольшее число торговых возможностей).
- **Итоговая сводка:** В конце работы скрипт печатает общую статистику: сколько всего пар было проанализировано, сколько из них успешно, а сколько было пропущено из-за нехватки данных.