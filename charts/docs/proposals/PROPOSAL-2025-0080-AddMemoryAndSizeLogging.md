# PROPOSAL-2025-0080: Внедрение логирования памяти и размера данных для точной диагностики сбоя

## Диагностика
Вы правы. Я поспешил с предложением решения, не предоставив окончательных доказательств причины сбоя. Логи показывают, что код приложения успешно завершает работу, но клиент получает оборванный ответ. Это с высокой вероятностью указывает на аварийное завершение процесса операционной системой из-за нехватки памяти (OOM) в момент сериализации и отправки большого ответа. Однако, это все еще гипотеза, которую необходимо доказать.

## Предлагаемое изменение
Для сбора конкретных доказательств я предлагаю добавить в `charts/server.py` логирование потребления памяти и размера итоговых данных. Это позволит нам увидеть, действительно ли происходит резкий скачок потребления памяти перед сбоем.

1.  **Добавить зависимость:** Необходимо установить библиотеку `psutil` для мониторинга системных ресурсов: `pip install psutil`.
2.  **Модифицировать `charts/server.py`:**
    -   Добавить импорты `psutil`, `os`, `sys`.
    -   Добавить логирование потребления памяти в ключевых точках.
    -   Добавить логирование размера итогового объекта `valid_results` перед его отправкой.

### Изменения в `charts/server.py`

```python
# Добавить в начало файла
import psutil
import sys

# ... существующий код

# Внутри get_dashboard_data, перед return
# ...
valid_results = [res for res in results if res is not None]
logging.info(f"Successfully processed {len(valid_results)} pairs.")

# --- НОВЫЙ КОД ДЛЯ ДИАГНОСТИКИ ---
try:
    # Логируем размер данных
    data_size_mb = sys.getsizeof(valid_results) / (1024 * 1024)
    logging.info(f"Size of final 'valid_results' list: {data_size_mb:.2f} MB")

    # Логируем использование памяти процессом
    process = psutil.Process(os.getpid())
    memory_mb = process.memory_info().rss / (1024 * 1024)
    logging.info(f"Current memory usage before serialization: {memory_mb:.2f} MB")
except Exception as mem_e:
    logging.error(f"Could not get memory/size info: {mem_e}")
# --- КОНЕЦ НОВОГО КОДА ---

response_data = {"charts_data": valid_results}
logging.info("Successfully created response data. Sending to client.")
return response_data
```

## Обоснование
Это изменение не решает проблему, а предоставляет нам **конкретные данные** для ее подтверждения. Если мы увидим в логах, что перед сбоем потребление памяти резко возрастает до сотен мегабайт или гигабайт, и что размер `valid_results` очень велик, гипотеза об OOM будет доказана. Это позволит нам перейти к решению (например, потоковой передаче) с полной уверенностью.

## Оценка рисков
Риск минимален. Добавление `psutil` и нескольких строк логирования не повлияет на основную логику, но даст критически важную диагностическую информацию.

## План тестирования
1.  Установить `psutil`: `pip install psutil`.
2.  Перезапустить сервер `charts`: `uvicorn charts.server:app --reload`.
3.  Воспроизвести ошибку, запросив большое количество пар.
4.  Проанализировать вывод в консоли. Нас интересуют последние сообщения о размере данных и потреблении памяти перед сбоем.

## План отката
1.  Отменить изменения в файле `charts/server.py`.
2.  Удалить `psutil` из зависимостей.