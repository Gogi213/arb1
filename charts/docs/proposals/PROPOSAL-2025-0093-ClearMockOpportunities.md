# PROPOSAL-2025-0093: Очистка глобальной переменной MOCK_OPPORTUNITIES

**Дата:** 2025-11-08
**Автор:** Kilo Code
**Статус:** Предложено

---

## 1. Компактный диагноз

**Проблема:** В `charts/server.py` существует глобальная переменная `MOCK_OPPORTUNITIES`, которая используется для инъекции тестовых данных через эндпоинт `/api/test/load_mock_data`. После загрузки `polars.DataFrame` в эту переменную, она никогда не очищается, оставаясь в памяти до завершения работы процесса.

**Последствия:** Это приводит к утечке памяти, которая может составлять несколько гигабайт (согласно аудиту OOM). При многократных вызовах тестового эндпоинта или при перезагрузке сервера без полного рестарта процесса, эта память не освобождается.

## 2. Предлагаемое изменение

Я предлагаю добавить логику очистки в обработчик `shutdown` жизненного цикла FastAPI (`lifespan`). Это гарантирует, что память будет освобождена при штатном завершении работы приложения.

```diff
<<<<<<< SEARCH
:start_line:228
-------
    # Stop background services
    rolling_window.stop_cleanup()
    # WebSocket task will be cancelled automatically on app exit
=======
    # Stop background services
    rolling_window.stop_cleanup()
    
    # Clear mock data to free up memory
    global MOCK_OPPORTUNITIES
    if MOCK_OPPORTUNITIES is not None:
        MOCK_OPPORTUNITIES = None
        logging.info("Cleared mock opportunities data.")
        
    # WebSocket task will be cancelled automatically on app exit
>>>>>>> REPLACE
```

## 3. Обоснование

- **Надежность:** Использование `lifespan` менеджера — это идиоматический и надежный способ выполнения кода при старте и остановке FastAPI приложения.
- **Эффективность:** Простое присваивание `None` позволяет сборщику мусора Python освободить память, занимаемую большим DataFrame.
- **Безопасность:** Изменение затрагивает только тестовый функционал и не несет рисков для основной логики приложения.

## 4. Оценка риска

**Нулевой.** Это изменение исправляет очевидную утечку в тестовом коде и не имеет побочных эффектов.

## 5. План тестирования

1.  **Сборка/Запуск:** Убедиться, что сервер `charts` запускается без ошибок.
2.  **Верификация:**
    а. Вызвать эндпоинт `/api/test/load_mock_data` с тестовыми данными.
    б. Проверить (например, по логам или через другой эндпоинт, если бы он был), что `MOCK_OPPORTUNITIES` не равно `None`.
    в. Штатно остановить сервер.
    г. Проверить лог на наличие сообщения "Cleared mock opportunities data.".

## 6. Шаги для отката

Удалить добавленный блок кода из функции `lifespan` в файле `charts/server.py`.