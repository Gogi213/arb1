# Детальное описание метрик и алгоритмов проекта Collections

Этот документ подробно описывает ключевые метрики и фильтры, используемые в проекте `SpreadAggregator`.

## 1. Основная метрика: Процентный спред (`SpreadPercentage`)

Основной метрикой, которая вычисляется в реальном времени, является процентный спред между лучшей ценой покупки (Bid) и лучшей ценой продажи (Ask).

### 1.1. Алгоритм вычисления (`SpreadCalculator.cs`)

*   **Класс:** `SpreadAggregator.Domain.Services.SpreadCalculator`
*   **Метод:** `public decimal Calculate(decimal bestBid, decimal bestAsk)`
*   **Входные данные:**
    *   `bestBid`: Лучшая (самая высокая) цена, по которой кто-либо готов купить актив.
    *   `bestAsk`: Лучшая (самая низкая) цена, по которой кто-либо готов продать актив.
*   **Формула:**
    ```
    (bestAsk - bestBid) / bestAsk * 100
    ```
*   **Описание:**
    *   Формула вычисляет разницу между ценой продажи и покупки, а затем нормализует ее относительно цены продажи (`bestAsk`), выражая результат в процентах.
    *   Этот показатель демонстрирует, какой процент от цены актива составляет разница между лучшими встречными заявками.
*   **Обработка ошибок:** Метод генерирует `DivideByZeroException`, если `bestAsk` равен нулю, чтобы избежать некорректных вычислений.

## 2. Фильтр по объему (`VolumeFilter`)

Перед тем как подписаться на обновления цен по торговому инструменту, система фильтрует его по суточному объему торгов, чтобы отсеять неликвидные или неинтересные рынки.

### 2.1. Алгоритм фильтрации (`VolumeFilter.cs`)

*   **Класс:** `SpreadAggregator.Domain.Services.VolumeFilter`
*   **Метод:** `public bool IsVolumeSufficient(decimal volume, decimal minVolume, decimal maxVolume)`
*   **Входные данные:**
    *   `volume`: Фактический 24-часовой объем торгов по инструменту в USD.
    *   `minVolume`: Минимально допустимый объем (из конфигурации `ExchangeSettings:Exchanges:{ExchangeName}:VolumeFilter:MinUsdVolume`).
    *   `maxVolume`: Максимально допустимый объем (из конфигурации `ExchangeSettings:Exchanges:{ExchangeName}:VolumeFilter:MaxUsdVolume`).
*   **Логика:**
    ```
    volume >= minVolume && volume <= maxVolume
    ```
*   **Описание:**
    *   Фильтр пропускает только те торговые инструменты, чей суточный объем находится в заданном диапазоне `[minVolume, maxVolume]`. Это позволяет сосредоточиться на рынках с достаточной ликвидностью, но при этом отсеять аномально крупные рынки, если это необходимо.

## 3. Метрики производительности системы (наблюдаемые)

Хотя эти метрики не вычисляются в доменной логике, они являются важными показателями здоровья и производительности приложения:

*   **Частота поступления данных:** Количество сообщений, обрабатываемых из `System.Threading.Channels` в единицу времени. Позволяет оценить интенсивность рыночной активности.
*   **Глубина очереди канала:** Количество элементов в `_rawDataChannel` и `_rollingWindowChannel`. Значительный рост этого показателя может свидетельствовать о том, что потребители (`OrchestrationService`, `ParquetDataWriter`) не справляются с потоком данных.
*   **Задержка E2E (End-to-End):** Время между получением сообщения от биржи (серверная метка времени) и отправкой вычисленного спреда через WebSocket. Это ключевой показатель производительности всей системы.