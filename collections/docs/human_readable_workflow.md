# Как на самом деле работает Spread Aggregator (Новостное агентство 2.0)

Представьте, что `SpreadAggregator` — это высокотехнологичное новостное агентство. У него есть два главных отдела, которые работают **одновременно и независимо друг от друга**, чтобы не создавать задержек: **Отдел прямого эфира** и **Архивный отдел**.

### 1. Открытие агентства (Запуск `Program.cs`)

- **Сбор команды:** "Главный редактор" (`Program.cs`) собирает команду:
  - **Корреспонденты** для каждой биржи (`BinanceExchangeClient` и др.).
  - **Аналитик** (`SpreadCalculator`).
  - **Охранник** (`VolumeFilter`).
  - **Ведущий прямого эфира** (`FleckWebSocketServer`).
  - **Смотритель за архивом** (`DataCollectorService`), который руководит **Архивным отделом**.
- **Создание "почтового ящика":** Редактор создает специальный внутренний "почтовый ящик" (`Channel`). Все "сырые" новости от корреспондентов будут сначала попадать сюда.
- **Запуск отделов:** Редактор дает команду, и оба отдела — **Прямого эфира** и **Архивный** — начинают работать параллельно.

### 2. Отдел прямого эфира (под руководством `OrchestrationService`)

- **Главный дирижер (`OrchestrationService`):** Он отвечает за все, что происходит в реальном времени.
- **Инструктаж корреспондентов:** Он дает им те же задания: найти интересные монеты и подписаться на обновления цен и сделок.
- **Поток новостей:** Корреспонденты начинают слать "сырые" данные (цены, сделки) не напрямую дирижеру, а **бросают их в общий "почтовый ящик" (`Channel`)**.
- **Обработка для эфира:** Одновременно с этим дирижер:
  - Берет *копию* новости о ценах.
  - Отдает ее аналитику для расчета спреда.
  - Передает готовую новость ведущему, который транслирует ее подписчикам.

**Ключевой момент:** Дирижер не ждет, пока данные запишутся в архив. Его задача — максимальная скорость доставки новостей в прямой эфир. Он просто бросает "сырые" данные в "почтовый ящик" и забывает о них, зная, что Архивный отдел сам их заберет.

### 3. Архивный отдел (под руководством `DataCollectorService`)

- **Смотритель за архивом (`DataCollectorService`):** Этот сотрудник работает в своем собственном темпе и его единственная задача — следить за "почтовым ящиком" (`Channel`).
- **Разбор почты:** Как только в "почтовом ящике" появляется новая пачка "сырых" данных, смотритель забирает ее.
- **Сортировка и запись:** Он аккуратно, не торопясь, раскладывает все данные по полочкам:
  - Создает папки по бирже, монете, дате и часу.
  - Записывает данные в файлы формата `.parquet` (это как цифровой архив, очень компактный и быстрый для будущего анализа).
  - Он делает это порциями (пачками), чтобы не перегружать систему.

**Почему это важно?**

Такое разделение труда позволяет агентству быть невероятно эффективным. **Отдел прямого эфира** никогда не тормозит из-за того, что **Архивный отдел** занят записью данных на диск. Они работают параллельно, что гарантирует максимальную скорость и надежность.