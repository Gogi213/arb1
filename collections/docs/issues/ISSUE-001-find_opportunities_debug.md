# ISSUE-001: Отладка скрипта find_opportunities.py

## 1. Проблема

Скрипт `analysis/find_opportunities.py` не обнаруживает данные, расположенные в подпапках `hour=...`. Это приводит к тому, что анализ не выполняется, так как скрипт считает, что данных нет.

## 2. Гипотеза

Исходная реализация `load_trades_for_symbol` использовала `pl.scan_parquet(".../**.parquet")`, что, возможно, некорректно обрабатывало структуру директорий с партициями (`/exchange=.../symbol=.../date=.../hour=...`).

## 3. Первое исправление (2025-10-31)

- **Изменение:** Заменил `load_trades_for_symbol` на новую версию, которая явно итерируется по директориям `date=*` и сканирует файлы внутри них.
- **Ожидание:** Скрипт должен корректно найти все `.parquet` файлы, включая те, что находятся в папках `hour=02` и `hour=03`, и обработать их.
- **Следующий шаг:** Запустить скрипт и проанализировать его вывод.

---

## 4. Результат теста (2025-10-31)

- **Статус:** НЕУДАЧА.
- **Вывод:**
  ```
  polars.exceptions.ColumnNotFoundError: unable to find column "Quantity"; valid columns: ["Timestamp", "BestBid", "BestAsk", "SpreadPercentage", "MinVolume", "MaxVolume", "Exchange", "Symbol"]
  ```
- **Анализ:** Ошибка `ColumnNotFoundError` указывает на фундаментальное несоответствие схемы данных. Скрипт ожидает колонки `Quantity` и `Price`, которые характерны для данных о сделках (trades). Однако загруженные данные содержат колонки `BestBid`, `BestAsk`, `SpreadPercentage`, что соответствует данным о спредах (spreads).
- **Новая гипотеза:** Скрипт `find_opportunities.py` указывает на неверную директорию. Он читает данные о спредах, а должен читать данные о сделках. Параметр `DATA_ROOT` в скрипте установлен в `../data/market_data`, что, по-видимому, является путем к данным о спредах.

## 5. План дальнейших действий

1.  Определить, где сервис `DataCollectorService` сохраняет данные о **сделках (trades)**. Для этого нужно изучить исходный код C# проекта.
2.  Изменить значение `DATA_ROOT` в `find_opportunities.py`, чтобы он указывал на правильную директорию с данными о сделках.
3.  Повторно запустить скрипт для проверки.

---

## 6. Анализ C# кода (2025-10-31)

- **Ключевые файлы:** `ParquetDataWriter.cs`, `GateIoExchangeClient.cs`.
- **Выводы:**
    1.  `ParquetDataWriter` является центральным обработчиком, который получает данные (и спреды, и сделки) через `Channel<MarketData>`.
    2.  Он сохраняет оба типа данных в **одну и ту же** корневую директорию: `data/market_data`.
    3.  Путь формируется по шаблону: `data/market_data/exchange={...}/symbol={...}/date={...}/hour={...}`.
    4.  Имена файлов различаются: `spreads-{timestamp}.parquet` для спредов и `trades-{timestamp}.parquet` для сделок.
- **Окончательный вывод:** Проблема не в `DATA_ROOT`, а в том, что скрипт `find_opportunities.py` читает **все** `.parquet` файлы из директории, включая файлы спредов, у которых другая схема.

## 7. Второе исправление (2025-10-31)

- **Изменение:** Изменен glob-паттерн в `load_trades_for_symbol` на `**/trades-*.parquet` для загрузки только файлов сделок.
- **Результат теста:** НЕУДАЧА.
- **Вывод:**
  ```
  polars.exceptions.ComputeError: expected at least 1 source
  ```
- **Анализ:** Ошибка `expected at least 1 source` от `pl.scan_parquet` означает, что glob-паттерн не нашел ни одного файла. Это может быть связано с особенностями реализации glob в `polars` или `pathlib`.
- **Новая гипотеза:** `pl.scan_parquet` с `**` может работать не так, как ожидается. Более надежный подход — использовать стандартную библиотеку `glob` для поиска файлов, а затем передать явный список файлов в `polars`.

## 8. Третье (финальное) исправление (2025-10-31)

- **Изменение:** `load_trades_for_symbol` переписана для использования `glob.glob` для рекурсивного поиска файлов и передачи явного списка в `pl.scan_parquet`.
- **Результат теста:** УСПЕХ.
- **Вывод:** Скрипт успешно завершился с кодом 0. В логах видно, что он корректно ищет файлы, но не находит их (`Файлы сделок не найдены...`).
- **Заключение:** Скрипт `find_opportunities.py` полностью отлажен и работает корректно. Проблема отсутствия результатов анализа заключается в **отсутствии самих данных о сделках** в директории `data/market_data`. Следующим шагом должна быть проверка процесса генерации данных (C# приложение `SpreadAggregator.Presentation`).

---