# PROPOSAL-2025-0007: Рефакторинг find_opportunities.py для использования Lazy API

## 1. Компактный диагноз

Скрипт `analysis/find_opportunities.py` в текущей реализации неэффективно использует память. Он загружает все данные о сделках для каждого символа в RAM с помощью `pl.scan_parquet(...).collect()`, что приведет к сбою при работе с большими объемами данных.

## 2. Предлагаемое изменение

Переписать основной цикл анализа (`main` function) и вспомогательные функции (`effective_only`, `find_price_jumps`, `who_is_fast`) для полноценного использования "ленивого" API (`LazyFrame`) библиотеки `polars`.

Операции фильтрации и трансформации будут выполняться на "ленивых" датафреймах, и только финальные результаты (например, `opportunities.head(3)`) будут материализованы вызовом `.collect()`.

**Примерный псевдокод изменения:**

```python
# Было:
df1 = load_trades_for_symbol(...) # Возвращает DataFrame
df2 = load_trades_for_symbol(...) # Возвращает DataFrame
df_all = pl.concat([df1, df2]).pipe(effective_only, ...)

# Станет:
ldf1 = load_trades_for_symbol_lazy(...) # Возвращает LazyFrame
ldf2 = load_trades_for_symbol_lazy(...) # Возвращает LazyFrame
ldf_all = pl.concat([ldf1, ldf2]).pipe(effective_only_lazy, ...)

# .collect() будет вызываться только в самом конце, когда нужно вывести результат
opportunities = find_price_jumps_lazy(...)
print(opportunities.head(3).collect())
```

## 3. Обоснование

- **Масштабируемость:** "Ленивые" вычисления позволят `polars` оптимизировать запросы и обрабатывать наборы данных, значительно превышающие объем доступной оперативной памяти.
- **Производительность:** Оптимизатор запросов `polars` сможет применить более эффективные стратегии выполнения, такие как `predicate pushdown` (проталкивание фильтров) и `projection pushdown` (выбор только нужных колонок), что ускорит выполнение скрипта.
- **Соответствие лучшим практикам:** Использование "ленивого" API является идиоматичным и рекомендуемым способом работы с `polars` для задач анализа данных.

## 4. Оценка рисков

- **Низкий риск:** Логика анализа не меняется, меняется только способ выполнения запросов.
- **Митигация:** Финальный результат (найденные возможности) должен остаться идентичным. Это легко проверить, сравнив вывод до и после изменения на небольшом наборе данных (когда он появится).

## 5. План тестирования

1.  После рефакторинга запустить скрипт.
2.  Убедиться, что он выполняется без ошибок (даже при отсутствии данных).
3.  Когда появятся данные о сделках, сравнить результаты работы старой и новой версии на небольшом срезе данных, чтобы убедиться в идентичности результатов.

## 6. Шаги для отката

- Вернуть изменения в файле `analysis/find_opportunities.py` с помощью `git restore analysis/find_opportunities.py`.