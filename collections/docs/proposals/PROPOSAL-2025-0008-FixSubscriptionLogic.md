# PROPOSAL-2025-0008: Исправление логики подписки на потоки данных

## 1. Компактный диагноз

В текущей реализации `IExchangeClient` и его клиентах (например, `GateIoExchangeClient`) методы `SubscribeToTickersAsync` и `SubscribeToTradesAsync` конфликтуют друг с другом. Каждый из них пересоздает подключения, обнуляя обработчик данных, установленный предыдущим вызовом. В результате приложение может обрабатывать либо только тикеры, либо только сделки, но не оба потока одновременно. Это является причиной, по которой данные о сделках не записываются, несмотря на `EnableTrades: true` в конфиге.

## 2. Предлагаемое изменение

Провести рефакторинг интерфейса `IExchangeClient` и всех его реализаций.

1.  **Изменить интерфейс `IExchangeClient`:**
    -   Удалить методы `SubscribeToTickersAsync` и `SubscribeToTradesAsync`.
    -   Добавить новый единый метод:
        ```csharp
        Task SubscribeAsync(IEnumerable<string> symbols, Action<SpreadData>? onTickerData, Action<TradeData>? onTradeData);
        ```

2.  **Обновить все реализации `IExchangeClient`:**
    -   Реализовать новый метод `SubscribeAsync`. Логика `SetupConnections` будет вызываться один раз с обоими делегатами.

3.  **Обновить `OrchestrationService`:**
    -   Заменить два раздельных вызова `SubscribeToTickersAsync` и `SubscribeToTradesAsync` на один вызов `SubscribeAsync`, передавая оба обработчика (или `null`, если соответствующий поток отключен в конфиге).

## 3. Обоснование

- **Корректность:** Это исправит фундаментальную ошибку в логике подписок и позволит приложению одновременно получать и обрабатывать данные о спредах и сделках, как и предполагалось.
- **Надежность:** Устраняется состояние гонки и неопределенное поведение, зависящее от порядка вызова методов.
- **Упрощение:** Единый метод подписки делает интерфейс более понятным и менее подверженным ошибкам при дальнейшем расширении.

## 4. Оценка рисков

- **Средний риск:** Изменение затрагивает ключевой интерфейс и все его реализации. Требуется внимательность при обновлении каждого клиента биржи.
- **Митигация:**
    -   Изменения будут вноситься последовательно для каждого клиента.
    -   Компилятор поможет отследить все места, требующие обновления.
    -   После исправления потребуется тщательное тестирование для подтверждения, что оба потока данных (тикеры и сделки) обрабатываются корректно.

## 5. План тестирования

1.  После рефакторинга запустить приложение.
2.  Убедиться по логам консоли, что приложение успешно подписывается и на тикеры (если включено), и на сделки.
3.  Проверить, что в директории `data/market_data` создаются файлы `trades-*.parquet`.
4.  Запустить скрипт `analysis/find_opportunities.py` и убедиться, что он находит и обрабатывает данные о сделках.

## 6. Шаги для отката

- Вернуть изменения во всех затронутых файлах с помощью `git restore`.