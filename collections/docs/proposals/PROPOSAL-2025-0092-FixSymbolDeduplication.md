# PROPOSAL-2025-0092: Устранение дублирования SymbolInfo при переподключениях

**Дата:** 2025-11-08
**Автор:** Kilo Code
**Статус:** Предложено

---

## 1. Компактный диагноз

**Проблема:** В `OrchestrationService.cs` метод `ProcessExchange` получает список символов от биржи и добавляет их в глобальный список `_allSymbolInfo` с помощью `AddRange`. Этот метод вызывается при каждом подключении или переподключении к бирже.

**Последствия:** Поскольку отсутствует механизм проверки на дубликаты, при каждом переподключении в `_allSymbolInfo` добавляется полный набор символов биржи заново. Это приводит к линейному и неограниченному росту потребления памяти, что является критической утечкой (P0), как указано в аудите OOM.

## 2. Предлагаемое изменение

Я предлагаю добавить простую логику дедупликации перед добавлением новых символов в список. Это можно сделать, проверив существующие символы.

```diff
<<<<<<< SEARCH
:start_line:84
-------
        _allSymbolInfo.AddRange(allSymbols);
=======
        var existingSymbols = new HashSet<string>(_allSymbolInfo.Select(s => s.Name));
        var newSymbols = allSymbols.Where(s => !existingSymbols.Contains(s.Name)).ToList();
        _allSymbolInfo.AddRange(newSymbols);
>>>>>>> REPLACE
```

## 3. Обоснование

- **Эффективность:** Использование `HashSet<string>` для хранения имен существующих символов обеспечивает проверку на дубликаты со сложностью O(1), что делает процесс очень быстрым, даже при большом количестве символов.
- **Надежность:** Это изменение гарантированно предотвращает добавление дубликатов в `_allSymbolInfo`, полностью решая проблему утечки памяти в этом компоненте.
- **Минимальное вмешательство:** Изменение локализовано в одном методе и не затрагивает остальную логику сервиса.

## 4. Оценка риска

**Очень низкий.** Логика изменения проста и очевидна. Она исправляет явную ошибку и не имеет известных побочных эффектов.

## 5. План тестирования

1.  **Сборка:** Убедиться, что проект `SpreadAggregator.Application` успешно компилируется.
2.  **Запуск:** Запустить приложение.
3.  **Верификация (логическая):** Проанализировать код и убедиться, что логика предотвращает добавление дубликатов. Если бы был доступен отладчик, можно было бы поставить точку останова и проверить, что `newSymbols.Count` равен нулю при повторном вызове `ProcessExchange` для той же биржи.

## 6. Шаги для отката

Вернуть изменения в файле `collections/src/SpreadAggregator.Application/Services/OrchestrationService.cs`, удалив добавленную логику дедупликации и оставив только исходную строку `_allSymbolInfo.AddRange(allSymbols);`.