# Backlog - Агрегатор биржевых спредов

## Спринт 7: Стабилизация коннекторов

- [ ] **Задача 1: Исправление нестабильности Gate.io**
    - [x] **Проблема:** Коннектор `GateIoExchangeClient` постоянно терял соединение, вызывая ошибки `Socket not open` и потерю данных.
    - [x] **Анализ:** Проблема была вызвана попыткой создать слишком много подписок на одном WebSocket-соединении, что приводило к его принудительному разрыву со стороны API Gate.io.
    - [x] **Решение (KISS & YAGNI):** Реализована логика, при которой для каждого пакета из 10 символов создается новый, независимый экземпляр `GateIoSocketClient`. Это распределяет нагрузку по нескольким соединениям и соответствует ограничениям API, устраняя причину сбоев.

## Спринт 6: Добавление серверного Timestamp
- [ ] **Задача 2: Исправление нестабильности Binance**
    - [x] **Проблема:** Периодические разрывы соединения для подписок Binance, ошибочно логируемые как "batch 4".
    - [x] **Анализ:** Выявлено две проблемы: 1) Ошибка замыкания в цикле, из-за которой все сообщения об ошибках приписывались последнему номеру пакета. 2) Превышение лимита подписок на одно WebSocket-соединение.
    - [x] **Решение (KISS & YAGNI):** Реализована логика, при которой для каждого пакета из 100 символов создается новый, независимый экземпляр `BinanceSocketClient`. Также исправлена ошибка логирования путем захвата номера пакета в локальную переменную.

- [x] **Задача 1: Реализация Timestamp**
    - [x] **Дополнение:** Несмотря на создание отдельных сокетов, проблема нестабильности сохранилась. Добавлена задержка в 500 мс между созданием каждого нового соединения, чтобы предотвратить срабатывание серверного rate-limiting'а на количество новых подключений в единицу времени.

    - [x] **Цель:** Добавить серверное время (timestamp) к данным, получаемым от каждой биржи, для более точного анализа и отладки.
    - [x] **Действия:**
        - [x] Добавить свойство `Timestamp` (тип `DateTime`) в класс `TickerData`.
        - [x] Написать TDD-тест, проверяющий, что `Timestamp` корректно устанавливается.
- [ ] **Задача 3: Исправление лимитов подписок OKX**
    - [x] **Проблема:** Коннектор `OkxExchangeClient` отбрасывал все символы, превышающие лимит в 100 подписок на соединение.
    - [x] **Анализ:** Выявлено, что код вручную ограничивал количество символов вместо того, чтобы обрабатывать их все.
    - [x] **Решение (KISS & YAGNI):** Логика подписки была переработана по аналогии с другими стабильными коннекторами. Реализована пакетная обработка, при которой для каждого пакета из 100 символов создается новый, независимый экземпляр `OKXSocketClient` с задержкой между пакетами.

        - [x] Обновить все реализации `IExchangeClient` (`BinanceExchangeClient`, `BingXExchangeClient`, и т.д.), чтобы они устанавливали `DateTime.UtcNow` в поле `Timestamp` при получении данных.
- [ ] **Задача 4: Исправление лимитов подписок Kucoin**
    - [x] **Проблема:** Коннектор `KucoinExchangeClient` отбрасывал все символы, превышающие лимит в 100 подписок на соединение.
    - [x] **Анализ:** Проблема была аналогична OKX — код вручную ограничивал количество символов.
    - [x] **Решение (KISS & YAGNI):** Логика подписки была переработана по аналогии с другими стабильными коннекторами. Реализована пакетная обработка, при которой для каждого пакета из 100 символов создается новый, независимый экземпляр `KucoinSocketClient` с задержкой между пакетами.

        - [x] Проверить, что данные с `Timestamp` корректно передаются до `OrchestrationService`.

## Спринт 5: Интеграция Bybit
- [x] **Задача 1: Подготовка и настройка**
    - [x] Добавить NuGet-пакет `Bybit.Net` в проект `SpreadAggregator.Infrastructure`.
    - [x] Создать файл `BybitExchangeClient.cs` в директории `src/SpreadAggregator.Infrastructure/Services/Exchanges/`.
    - [x] Зарегистрировать `BybitExchangeClient` в DI-контейнере в `Program.cs`.
    - [x] Добавить секцию "Bybit" в `appsettings.json` с параметрами фильтрации по объему.
- [x] **Задача 2: Реализация `BybitExchangeClient`**
    - [x] Реализовать интерфейс `IExchangeClient`.
    - [x] Реализовать метод `GetSymbolsAsync` для получения всех спотовых символов.
    - [x] Реализовать метод `GetTickersAsync` для получения всех тикеров и их 24-часового объема.
    - [x] Реализовать метод `SubscribeToTickersAsync` для подписки на обновления книги ордеров.
- [x] **Задача 3: Отладка и исправление подписки**
    - [x] **Проблема:** Данные от Bybit не поступали на фронтенд.
    - [x] **Анализ:** Логи показали, что сервер Bybit отклоняет запросы на подписку, если в них больше 10 символов (`args size > 10`).
    - [x] **Решение (KISS & YAGNI):** Реализована логика батчинга в `BybitExchangeClient`. Список символов теперь делится на группы по 10, и на каждую группу отправляется отдельный запрос на подписку. Это минимально необходимое изменение для соблюдения ограничений API.
    - [x] Исправлена ошибка в `appsettings.json` (неправильная вложенность).
    - [x] Включено детальное логирование для Bybit для облегчения диагностики.

## Спринт 4: Интеграция OKX
- [x] **Задача 1: Подготовка и настройка**
    - [x] Добавить NuGet-пакет `JK.OKX.Net` в проект `SpreadAggregator.Infrastructure`.
    - [x] Создать файл `OkxExchangeClient.cs` в директории `src/SpreadAggregator.Infrastructure/Services/Exchanges/`.
    - [x] Зарегистрировать `OkxExchangeClient` в DI-контейнере в `Program.cs`.
    - [x] Добавить секцию "OKX" в `appsettings.json` с параметрами фильтрации по объему.
- [x] **Задача 2: Реализация `OkxExchangeClient`**
    - [x] Реализовать интерфейс `IExchangeClient`.
    - [x] Реализовать метод `GetTickersAsync` для получения всех тикеров и их 24-часового объема.
    - [x] Реализовать метод `SubscribeToTickersAsync` для подписки на обновления книги ордеров (book ticker).
- [ ] **Задача 3: Тестирование и отладка**
    - [ ] Проверить корректность получения данных по объему и фильтрации символов.
    - [ ] Убедиться в стабильности WebSocket-подписки и корректности получаемых данных о спреде.

- [x] **Задача 4: Автоматическая валидация данных Bitget**
    - [x] **Цель:** Создать автоматический валидатор для сравнения потоков данных между C# приложением и эталонным клиентом (CCXT).
    - [x] **Действие:** Реализован Python-скрипт (`validation/bitget_validator.py`), который динамически определяет активный символ, подключается к обоим WebSocket-потокам и сравнивает `bestBid`/`bestAsk`.
    - [x] **Результат:** Валидатор запущен и выявил периодические микро-расхождения (менее 0.03%) между C# и CCXT, вероятно, связанные с задержками или разницей в обработке. Задача по созданию инструмента для выявления расхождений выполнена.
- [x] **Задача 5: Автоматическая валидация данных KuCoin**
    - [x] **Цель:** По аналогии с Bitget, проверить корректность данных от коннектора KuCoin.
    - [x] **Действие:** Создан скрипт `validation/kucoin_validator.py` для динамического сравнения потоков данных KuCoin.
    - [x] **Результат:** Валидатор запущен. Выявлены аналогичные микро-расхождения, подтверждающие общую корректность работы C# коннектора с незначительными отклонениями.
- [x] **Задача 6: Автоматическая валидация данных Binance**
    - [x] **Цель:** Проверить корректность данных от коннектора Binance.
    - [x] **Действие:** Создан скрипт `validation/binance_validator.py`.
    - [x] **Результат:** Валидатор запущен. Расхождений не выявлено, что подтверждает идеальную работу C# коннектора для Binance.
- [x] **Задача 7: Автоматическая валидация данных OKX**
    - [x] **Цель:** Проверить корректность данных от коннектора OKX.
    - [x] **Действие:** Создан скрипт `validation/okx_validator.py`.
    - [x] **Результат:** **ИСПРАВЛЕНО.** После исправления C# клиента (`OkxExchangeClient.cs`) путем замены подписки `SubscribeToOrderBookUpdatesAsync` на `SubscribeToTickerUpdatesAsync`, повторная валидация показала, что данные `bestBid`/`bestAsk` теперь поступают корректно. Оставшиеся микро-расхождения находятся в пределах нормы.
  - [x] **Задача 8: Автоматическая валидация данных MEXC**
      - [x] **Цель:** Проверить корректность данных от коннектора MEXC.
      - [x] **Действие:** Создан и запущен скрипт `validation/mexc_validator.py` по аналогии с существующими.
      - [x] **Результат:** Валидатор запущен и успешно сравнивает данные, выявляя расхождения. Задача выполнена.
  ## Рефакторинг
  - [x] **Оптимизация формата данных WebSocket:**
      - [x] Создан `SpreadDataPackage` DTO для компактного представления данных.
    - [x] `OrchestrationService` обновлен для формирования нового формата (массив массивов).
    - [x] `client.html` обновлен для парсинга нового формата.
- [x] **Устранение OutOfMemoryException:**
    - [x] Создан `SpreadDataCache` для агрегации данных о спредах.
    - [x] `OrchestrationService` переработан для использования кэша.
    - [x] Реализована фоновая отправка данных из кэша раз в секунду для снижения нагрузки на WebSocket.
- [x] **Удаление OKX:**
    - [x] Удалена зависимость `OKX.Api` из проекта `SpreadAggregator.Infrastructure`.
    - [x] Проведена очистка артефактов сборки для полного удаления связанных файлов.

## Спринт 3: Интеграция KuCoin
- [x] **Интеграция с KuCoin:**
    - [x] Добавлен пакет `Kucoin.Net`.
    - [x] Создан `KucoinExchangeClient`.
    - [x] Исправлены ошибки компиляции, связанные со структурой данных `KucoinStreamBestOffers`.
    - [x] `KucoinExchangeClient` зарегистрирован в DI.
    - [x] `appsettings.json` обновлен для поддержки KuCoin.

## Спринт 2: Интеграция MEXC и рефакторинг
- [x] **Рефакторинг DI и OrchestrationService:**
    - [x] Упрощен `IExchangeClient` (удален метод `GetClient`).
    - [x] Удален неиспользуемый `ExchangeFactory`.
    - [x] `OrchestrationService` переработан для работы с `IEnumerable<IExchangeClient>`.
    - [x] Логика запуска обработки бирж вынесена в `OrchestrationService` и основывается на конфигурации.
- [x] **Интеграция с MEXC:**
    - [x] Добавлен пакет `JK.Mexc.Net`.
    - [x] Создан `MexcExchangeClient`.
    - [x] `MexcExchangeClient` зарегистрирован в DI.
    - [x] `appsettings.json` обновлен для поддержки MEXC.
- [x] **Тестирование и отладка:**
    - [x] Исправлена ошибка с размером пакета подписки для MEXC.
    - [x] Скорректированы параметры фильтрации для MEXC.

## MVP 1.0: Основной функционал (Завершено)

### Архитектура и настройка
- [x] Создать структуру проекта (Domain, Application, Infrastructure, Presentation, Tests).
- [x] Настроить зависимости между проектами.
- [x] Создать `appsettings.json` с базовой конфигурацией.
- [x] Создать `docs/backlog.md` для ведения задач.

### Слой домена (Domain)
- [x] Создать сущность `SpreadData` для хранения информации о спреде.
- [x] Реализовать сервис `SpreadCalculator` с методом для расчета спреда.
- [x] Реализовать сервис `VolumeFilter` с методом для фильтрации пар по объему.

### Тестирование (TDD)
- [ ] Написать Unit-тест для `SpreadCalculator`.
- [ ] Написать Unit-тест для `VolumeFilter`.

### Слой инфраструктуры (Infrastructure)
- [x] Установить `Binance.Net`.
- [x] Реализовать `BinanceExchangeClient` для получения данных с биржи.
- [x] Реализовать `FleckWebSocketServer` для трансляции данных.

### Слой приложения (Application)
- [x] Создать `OrchestrationService` для управления потоками данных.

### Слой представления (Presentation)
- [x] Настроить DI-контейнер.
- [x] Реализовать `Program.cs` для запуска приложения.
- **Feature:** Implemented Bitget exchange connector.
## 2025-10-16

- **Refactor:** Обновлен `MexcExchangeClient` для корректной обработки большого количества подписок путем их разделения на батчи.
- **Refactor:** Настроена конфигурация логирования для уменьшения "шума" от `System.Net.Http.HttpClient` и `BingX`.
## 2025-10-16 (Update)

- **Fix:** Исправлена проблема с лимитом подписок в `MexcExchangeClient` путем создания новых WebSocket-соединений при достижении лимита.
## 2025-10-16 (Update 2)

- **Fix:** Скорректирован лимит подписок для `MexcExchangeClient` до 30 и улучшена логика создания новых соединений для предотвращения ошибок.
## 2025-10-16 (Update 3)

- **Fix:** Устранены предупреждения `CS8601` в `BitgetExchangeClient`, `KucoinExchangeClient` и `MexcExchangeClient` путем добавления проверок на `null` для повышения надежности кода.
## 2025-10-16 (Update 4)

- **Test:** Проведено нагрузочное тестирование с измененными параметрами объема (`minVolume` = 1 500 000, `maxVolume` = 100 000 000 000).
## 2025-10-16 (Update 5)

- **UI:** Уменьшен размер шрифта на 20% и убран заголовок в `client.html`.
## 2025-10-16 (Update 6)

- **UI:** Для биржи `BingX` в `client.html` теперь отображаются `Best Bid`, `Best Ask` и спред.
## 2025-10-16 (Update 7)

- **UI:** Для всех бирж в `client.html` теперь отображаются `Best Bid`, `Best Ask` и спред.
## 2025-10-16 (Update 8)

- **UI:** В `client.html` уменьшен размер шрифта, спред округлен до 2 знаков, а из названий символов убраны "USDT", "-", "_".
## 2025-10-16 (Update 9)

- **UI:** Уменьшены отступы в таблице для более компактного вида.
## 2025-10-16 (Update 10)

- **UI:** Уменьшен размер шрифта еще на 20%.
## 2025-10-16 (Update 11)

- **Fix:** Исправлена проблема с некорректным спредом для `BingX` путем перехода на `SubscribeToBookPriceUpdatesAsync` вместо построения полного стакана ордеров.
- **Refactor:** Удалена неиспользуемая зависимость `IBingXOrderBookFactory`.
## 2025-10-16 (Update 12)

- **Fix:** Восстановлена регистрация сервисов `BingX` для исправления ошибки `Unable to resolve service`.
## 2025-10-17

- **Docs:** Предоставлено концептуальное руководство по созданию системы межбиржевого статистического арбитража.
## 2025-10-17 (Update)

- **Docs:** Добавлено разъяснение по вопросу начальной подготовки портфеля и способам приобретения базового актива для старта арбитража.
## 2025-10-17 (Update 2)

- **Docs:** Предоставлен детальный, пошаговый сценарий двух полных циклов арбитража с расчетом комиссий, прибыли и ребалансировки портфеля.
## 2025-10-17 (Update 3)

- **Docs:** Добавлено ключевое разъяснение по механике сделок (покупка по Ask, продажа по Bid) и объяснена необходимость "обратных сделок" как неотъемлемой части непрерывного арбитражного цикла.
## 2025-10-17 (Update 4)

- **Docs:** Добавлено финальное разъяснение по механике стакана: покупка для мгновенной сделки всегда происходит по цене Ask, а продажа — по цене Bid. Объяснена невозможность "купить по Bid".
## 2025-10-17 (Update 5)

- **Docs:** Добавлено критически важное разъяснение о риске исполнения при использовании лимитных ордеров (Maker-Taker). Подтверждено, что для классического арбитража необходима Taker-Taker стратегия (покупка по Ask, продажа по Bid) для гарантии мгновенного и синхронного исполнения.
## 2025-10-17 (Update 6)

- **Docs:** Проведено финальное обсуждение продвинутой стратегии Maker-Taker с триггером по исполнению. Объяснен ключевой недостаток — риск задержки (latency risk) между исполнением двух "ног" сделки, который превращает ее в статистический, а не безрисковый арбитраж.
## 2025-10-17 (Update 7)

- **Feature:** Создано техническое задание (ТЗ) для ИИ-разработчика на реализацию модуля "Setup Finder" — сервиса для поиска и формирования арбитражных сетапов.
## 2025-10-17 (Update 8)

- **Docs:** Создан концептуальный документ "Концепция и алгоритм модуля 'Setup Finder'", описывающий логику и алгоритмы без использования программного кода, для передачи другому ИИ.