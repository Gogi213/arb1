graph TD
    subgraph "External Systems"
        Exchanges[Exchange APIs & WebSockets]
    end

    subgraph "Project: collections"
        direction TB
        Collections["<b>collections</b><br>(C# Data Hub)"]
        Collections_Process["Processes &<br>Calculates Spreads"]
        
        Collections -- "1. Ingests raw data" --> Collections_Process
        Collections_Process -- "2a. Broadcasts Spreads" --> Collections_WS_Out["WebSocket Server"]
        Collections_Process -- "2b. Writes Raw Data<br><b>(Incomplete Data)</b>" --> DataLake[(Parquet Files)]
    end
    
    subgraph "Project: trader"
        Trader["<b>trader</b><br>(C# Bot)"]
        
        subgraph "Active Mode"
            direction LR
            Trader_Convergent["ConvergentTrader"]
            Trader_Convergent -- "Executes Trades" --> Exchanges
        end
        
        subgraph "Passive/Legacy Mode"
            direction LR
            Trader_Listener["SpreadListener"]
            Trader_Listener -- "Listens" --> Collections_WS_Out
            Trader_Listener --> Trader_Halt((Stops Here))
        end

        Trader -- "Runs in one of two modes" --> Trader_Convergent
        Trader -- "Runs in one of two modes" --> Trader_Listener
    end

    subgraph "Project: analyzer"
        Analyzer["<b>analyzer</b><br>(Python Analysis)"]
        Analyzer -- "3. Reads historical data" --> DataLake
        Analyzer -- "4. Generates reports" --> Reports[(CSV Reports)]
    end
    
    subgraph "Human Interaction"
        Operator[Human Operator]
        Operator -- "5. Reads reports" --> Reports
        Operator -- "6. Configures & Runs" --> Trader_Convergent
    end

    Exchanges --> Collections

    classDef project fill:#ececff,stroke:#9090ff,stroke-width:2px,font-weight:bold
    class Collections,Trader,Analyzer project
    
    style Trader_Halt fill:#f9f,stroke:#333,stroke-width:2px
    style Trader_Convergent fill:#9cf,stroke:#333,stroke-width:2px