# Общий поток данных в системе ARB1

Этот документ описывает сквозной поток данных между тремя основными компонентами системы: `collections`, `analyzer` и `trader`.

## 1. Поток данных в реальном времени (Real-time Flow)

Этот поток предназначен для обнаружения и исполнения арбитражных сделок с минимальной задержкой.

1.  **Сбор данных:** `collections` (`SpreadAggregator`) подключается к WebSocket-потокам данных нескольких бирж.
2.  **Расчет спредов:** Внутри `collections` происходит непрерывный расчет арбитражных спредов.
3.  **Трансляция спредов:** `collections` немедленно транслирует каждый вычисленный спред через свой собственный WebSocket-сервер.
4.  **Получение сигнала:** `trader` (`SpreadListener`) подключается к WebSocket-серверу `collections` и получает поток данных о спредах.
5.  **Принятие решения:** `trader` (`DecisionMaker`) анализирует полученный спред. Если он превышает заданный порог, принимается решение о начале торгового цикла.
6.  **Исполнение (НЕ РЕАЛИЗОВАНО):** `trader` **не инициирует** торговые операции. Его логика заканчивается на `TODO`-заглушке.

## 2. Поток исторических данных (Historical/Batch Flow)

Этот поток предназначен для оффлайн-анализа и поиска статистических закономерностей.

1.  **Сбор и сохранение:** `collections` (`ParquetDataWriter`) асинхронно сохраняет все сырые рыночные данные в Parquet-файлы.
    *   **ВАЖНО:** Из-за архитектурной ошибки (конкурирующие потребители), `ParquetDataWriter` получает только **часть** общего потока данных, что делает сохраняемые данные неполными.
2.  **Чтение и анализ:** `analyzer` (`run_all_ultra.py`) запускается как отдельный процесс, сканирует директорию с Parquet-файлами.
3.  **Параллельная обработка:** `analyzer` в несколько процессов и потоков обрабатывает исторические данные, вычисляя статистические метрики.
4.  **Генерация отчета:** `analyzer` создает CSV-отчет с рейтингом наиболее перспективных для арбитража торговых пар.
5.  **Принятие стратегических решений:** Разработчики используют этот отчет для принятия решений о том, какие торговые пары следует добавить в конфигурацию `trader`.

## Сводная схема

*   **`collections`** -> (WebSocket) -> **`trader`** (Real-time)
*   **`collections`** -> (Неполные Parquet-файлы из-за ошибки) -> **`analyzer`** (Historical)
*   **`analyzer`** -> (Отчет) -> **Человек** -> (Конфигурация) -> **`trader`** (Стратегическое управление)
