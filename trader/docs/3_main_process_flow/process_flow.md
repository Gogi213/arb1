# Детальный процесс работы проекта Trader

Этот документ описывает пошаговый поток данных и логику работы сервисов в приложении `Trader` в его текущем состоянии.

## 1. Запуск приложения (`Program.cs`)

1.  **Конфигурация:** Приложение загружает настройки из `appsettings.json`, в частности, `SpreadListenerUrl`.
2.  **Инициализация `SpreadListener`:** Создается экземпляр `SpreadListener`, который отвечает за подключение к источнику спредов.
3.  **Инициализация `DecisionMaker`:** Создается экземпляр `DecisionMaker`, который будет принимать решения на основе обнаруженных спредов.
4.  **Подписка `DecisionMaker`:** `DecisionMaker` подписывается на событие `OnProfitableSpreadDetected` от `SpreadListener`.
5.  **Запуск `SpreadListener`:** Вызывается `listener.StartAsync()`, который запускает основной цикл работы приложения.

## 2. Обнаружение спредов (`SpreadListener`)

1.  **Подключение к источнику спредов:** `SpreadListener` устанавливает WebSocket-соединение с внешним `SpreadAggregator` (проектом `Collections`), используя URL из конфигурации.
2.  **Получение данных о спредах:** В реальном времени `SpreadListener` получает сообщения о спредах.
3.  **Расчет и фильтрация:** Для каждого полученного спреда `SpreadListener` выполняет внутренние расчеты и проверки.
4.  **Генерация события:** Если спред превышает заданный порог (0.25%), `SpreadListener` инициирует событие `OnProfitableSpreadDetected`, передавая направление арбитража (например, `GateIo_To_Bybit`) и размер спреда.

## 3. Принятие решений (`DecisionMaker`)

1.  **Обработка события:** `DecisionMaker` получает событие `OnProfitableSpreadDetected`.
2.  **Проверка флага `_isCycleInProgress`:**
    *   Если флаг `_isCycleInProgress` установлен в `true` (что означает, что предыдущий цикл уже запущен), новое событие игнорируется.
    *   Если флаг `_isCycleInProgress` равен `false`, он устанавливается в `true`.
3.  **Логирование:** `DecisionMaker` логирует обнаружение прибыльного спреда и намерение начать арбитражный цикл.
4.  **ТОЧКА ОСТАНОВКИ (TODO):** **На этом этапе текущий процесс завершается.** В коде `DecisionMaker.cs` находится `TODO`-комментарий, указывающий на отсутствие реализации логики для:
    *   Получения экземпляров `ArbitrageTrader` или `ReverseArbitrageTrader`.
    *   Запуска соответствующего трейдера на основе `direction`.
    *   Ожидания завершения торгового цикла и сброса флага `_isCycleInProgress` в `false`.

Таким образом, текущий поток работы приложения заканчивается на этапе обнаружения и логирования прибыльного спреда, без фактического исполнения торговых операций.
