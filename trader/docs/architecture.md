# Архитектура Проекта Trader

## Обзор

Проект Trader реализует высокопроизводительную систему арбитражной торговли между криптовалютными биржами Bybit и Gate.io. Архитектура построена на принципах разделения ответственности, асинхронного программирования и низкой латентности.

## Основные Компоненты

### Core Модуль

#### IExchange Интерфейс
Определяет контракт для взаимодействия с биржами:
- `InitializeAsync` - инициализация с API ключами
- `GetBalanceAsync` - получение баланса актива
- `PlaceOrderAsync` - размещение ордеров
- `SubscribeToOrderBookUpdatesAsync` - подписка на обновления стакана
- `SubscribeToOrderUpdatesAsync` - подписка на обновления ордеров
- `SubscribeToBalanceUpdatesAsync` - подписка на обновления баланса

#### ArbitrageTrader
Основная логика арбитража Leg 1 (Gate.io -> Bybit):
- Trailing покупка на Gate.io
- Рыночная продажа на Bybit
- Управление состоянием цикла через ArbitrageCycleState

#### ReverseArbitrageTrader
Логика арбитража Leg 2 (Bybit -> Gate.io):
- Trailing покупка на Bybit
- Рыночная продажа на Gate.io
- Синхронизация с результатами Leg 1

#### DecisionMaker
Компонент принятия решений для Спринта 5:
- Подписка на события SpreadListener
- Триггер арбитражных циклов при превышении спреда 0.25%
- Предотвращение параллельных циклов

#### SpreadListener
WebSocket-клиент для получения данных о спредах:
- Подключение к внешнему SpreadAggregator (проект collections)
- Расчет спредов между Gate.io и Bybit
- Триггер событий profitable spread

#### TrailingTrader
Реализация trailing-логики для лимитных ордеров:
- Динамический расчет цены на основе стакана
- Поддержка глубины в долларах

### Exchanges Модуль

#### BybitExchange
Адаптер для Bybit:
- Использует BybitLowLatencyWs для WebSocket коммуникации
- Поддержка локального стакана (snapshot + delta)
- Адаптеры для ордеров и балансов

#### GateIoExchange
Адаптер для Gate.io:
- Использует библиотеку jkorf/GateIo.Net
- Простая реализация без кастомного WS клиента

### Host Модуль

#### Program.cs
Точка входа приложения:
- Загрузка конфигурации из appsettings.json
- Инициализация компонентов
- Запуск SpreadListener как основного цикла

#### ExchangeConfig
Модель конфигурации для бирж:
- API ключи и секреты
- URL для SpreadListener

## Архитектурные Паттерны

### Адаптер
- Разделение core-логики от exchange-specific реализаций
- Легкое добавление новых бирж

### Асинхронный Контроль Потока
- TaskCompletionSource для управления асинхронными операциями
- SemaphoreSlim для синхронизации

### Debouncing
- Таймеры для стабилизации частых обновлений балансов (150ms)
- Предотвращение race conditions

### Паттерн Наблюдатель
- События для обновлений ордеров, балансов, спредов
- Разделение логики обработки и получения данных

## Коммуникация

### WebSocket
- BybitLowLatencyWs: Кастомный клиент с ручным JSON парсингом
- Низкая латентность, поддержка аутентификации
- Подписки на ордербуки, ордера, балансы

### Внешние Зависимости
- SpreadAggregator (проект collections): Источник данных о спредах
- Синхронизация контракта SpreadData между проектами

## Финансовая Точность

- Использование decimal для избежания floating-point ошибок
- Math.Truncate вместо Math.Round для предотвращения перерасхода
- Корректное округление количеств согласно фильтрам бирж

## Безопасность

- HMAC-SHA256 для аутентификации Bybit WS
- Хранение API ключей в конфигурации
- Валидация ордеров перед отправкой

## Расширяемость

Архитектура позволяет легко добавить:
- Новые биржи через реализацию IExchange
- Дополнительные стратегии через наследование от ITrader
- Новые источники данных через паттерн адаптер
