# Backlog

## Sprint 1: Basic Order Operations (Completed)

- [x] View account balance.
- [x] Cancel all existing limit orders for XRP_USDT.
- [x] Place a new limit buy order for XRP_USDT at price 2.3.
- [x] Modify the price of the existing order to 2.2.

## Sprint 2: Trailing Limit Order

- [ ] Get the current best bid price.
- [ ] Place a limit order 1% below the best bid.
- [ ] Implement a tracking mechanism using WebSockets to modify the order price for 2 minutes.
---

### Задача: Отладка и исправление арбитражного цикла

**Дата:** 25.10.2025

**Проблема:**
После исполнения ордера на покупку на Gate.io, ордер на продажу на Bybit не выставлялся, и программа преждевременно завершала работу. Дополнительно, после исправления первой проблемы, обнаружилось, что `TrailingTrader` выставляет второй ордер на покупку после исполнения первого.

**Анализ и принятые решения:**

1.  **Диагностика WebSocket:**
    *   **Гипотеза:** Первоначально предполагалось, что метод `PlaceOrderAsync` через WebSocket в библиотеке `Bybit.Net` не работает для спотового рынка на Unified-аккаунтах.
    *   **Проверка:** Был модифицирован и запущен ручной тест (`manual-tests/Program.cs`), который подтвердил, что WebSocket-вызов **работает корректно** при правильных параметрах (сумма ордера >= 5 USD).
    *   **Вывод:** Проблема не в WebSocket, а в логике приложения.

2.  **Исправление преждевременного завершения программы:**
    *   **Причина:** `ArbitrageTrader` запускал `TrailingTrader`, но не дожидался завершения всего арбитражного цикла. Метод `HandleBuyOrderFilled` был `async void`, и программа завершалась до его выполнения.
    *   **Решение:**
        *   В `ArbitrageTrader` добавлен `TaskCompletionSource` для управления жизненным циклом. Метод `StartAsync` теперь возвращает `Task`, который завершается только после подтверждения продажи на Bybit.
        *   `Program.cs` теперь ожидает (`await`) завершения этой задачи.
        *   `TrailingTrader` больше не останавливает сам себя; его останавливает `ArbitrageTrader` после завершения всего цикла.

3.  **Исправление выставления второго ордера:**
    *   **Причина:** Была обнаружена "гонка состояний" в `TrailingTrader`. После исполнения ордера и обнуления `_orderId`, обработчик стакана успевал получить новую цену и выставить новый ордер до полной остановки.
    *   **Решение:**
        *   В `TrailingTrader` добавлен флаг `private bool _isFilled;`.
        *   Этот флаг устанавливается в `true` немедленно при исполнении ордера.
        *   Обработчик стакана теперь проверяет этот флаг в самом начале (`if (_isFilled) return;`), что гарантированно предотвращает любую новую торговую активность.

**Результат:**
Все проблемы устранены. Арбитражный цикл (покупка на Gate.io -> продажа на Bybit) теперь выполняется полностью и корректно. Программа штатно завершает работу после получения подтверждения об исполнении ордера на продажу.