# Основной Поток Операций (Реализованная Логика)

Этот документ описывает **реализованный и работающий** полный цикл операций, разделяя "источник значения" и "источник средств".

---

### Подготовка

**0. Снепшот начального баланса Gate.io**
-   **Источник значения:** Баланс `H` на **Gate.io** *до начала цикла*.
-   **Назначение:** Сохраняется в `ArbitrageCycleState.InitialGateIoBaseAssetBalance`. Используется для финальных расчетов, но **не для определения объема продажи**.

---

### LEG 1: Gate.io -> Bybit

**1. Gate.io: Лимитный ордер на покупку (Trailing)**
-   **Источник значения (Сумма):** `gateIoConfig.Amount` из `appsettings.json`.
-   **Источник средств (Деньги):** Баланс `USDT` на **Gate.io**.
-   **Результат:** `H` зачислен на баланс **Gate.io**.

**2. Сохранение исполненного объема**
-   **Источник значения:** **Фактически исполненное количество `H`** из ордера на шаге 1 (`filledOrder.Quantity`).
-   **Назначение:** Сохраняется в `ArbitrageCycleState.Leg1GateBuyFilledQuantity` для использования в `Leg 2`.

**3. Bybit: Рыночный ордер на продажу**
-   **Источник значения (Количество):** Количество, полученное из **обновления баланса** на Gate.io после покупки (может включать "пыль" и быть неточным).
-   **Источник средств (Актив):** Баланс `H` на **Bybit**.
-   **Результат:** `H` списан с баланса **Bybit**, `USDT` зачислен на баланс **Bybit**.

**4. Снепшот USDT от продажи**
-   **Источник значения:** Количество USDT, полученное от продажи на шаге 3 (`cumExecValue` из ордера Bybit).
-   **Назначение:** Переменная `leg1ResultUsdtAmount` передается в `Leg 2`.

---

### LEG 2: Bybit -> Gate.io

**5. Bybit: Лимитный ордер на покупку (Trailing)**
-   **Источник значения (Сумма):** Переменная `leg1ResultUsdtAmount` из `Leg 1`.
-   **Источник средств (Деньги):** Баланс `USDT` на **Bybit**.
-   **Результат:** `USDT` списаны с баланса **Bybit**, `H` зачислен на баланс **Bybit**.

**6. Gate.io: Рыночный ордер на продажу**
-   **Источник значения (Количество):** **Фактически исполненное количество `H` с шага 1**, сохраненное в `ArbitrageCycleState.Leg1GateBuyFilledQuantity`.
-   **Источник средств (Актив):** Баланс `H` на **Gate.io**.
-   **Результат:** Цикл ребалансировки завершен. `H` продан на **Gate.io**.