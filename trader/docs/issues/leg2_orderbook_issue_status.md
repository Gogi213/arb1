# Статус: Проблема с подпиской на стакан Bybit (Leg 2)

**Дата:** 2025-10-28

## 1. Описание проблемы

В рамках реализации "Leg 2" (покупка на Bybit, продажа на Gate.io) возникла критическая проблема: трейлинг-логика на Bybit (`BybitTrailingTrader`) не получает данные о стакане (order book) после отправки запроса на подписку через WebSocket. Это блокирует весь арбитражный цикл.

**Наблюдаемое поведение (из `logs.txt`):**
1.  Успешное подключение к публичному WebSocket эндпоинту Bybit: `wss://stream.bybit.com/v5/public/spot`.
2.  Отправка запроса на подписку: `[WS-PUBLIC-SEND] {"op":"subscribe","args":["orderbook.50.HUSDT"]}`.
3.  **Проблема:** Отсутствие какого-либо ответа от сервера (ни подтверждения, ни ошибки, ни данных `snapshot`/`delta`).
4.  Программа зависает в ожидании данных.

## 2. Проведенные исследования и гипотезы

### Гипотеза 1: Неправильный формат топика
*   **Предположение:** Формат строки `"orderbook.50.HUSDT"` был неверным.
*   **Исследование:**
    *   Изучена официальная документация Bybit WebSocket v5. Формат `orderbook.{depth}.{symbol}` подтвержден.
    *   Изучен исходный код библиотеки `Bybit.Net` (`BybitOrderBookSubscription.cs`). Он также использует конкатенированную строку в качестве топика.
*   **Вывод:** Формат топика, скорее всего, **верен**. Гипотеза отклонена.

### Гипотеза 2: Неправильная обработка сообщений (`snapshot`/`delta`)
*   **Предположение:** Данные приходят, но код не может их обработать, так как не различает `snapshot` и `delta` типы сообщений.
*   **Исследование:**
    *   Предложен `PROPOSAL-2025-0002` для реализации полноценной логики поддержания локального стакана.
    *   Изменения были внесены в `BybitLowLatencyWs.cs`.
    *   Проведен повторный запуск.
*   **Вывод:** Проблема осталась. Новые логи показали, что данные по-прежнему **не приходят** от сервера. Следовательно, проблема не в обработке, а в самой подписке. Гипотеза отклонена.

### Гипотеза 3: Неправильный модификатор доступа (Ошибка компиляции)
*   **Предположение:** Ошибка компиляции `CS1527` мешала сборке.
*   **Исследование:** Вспомогательный класс `MaintainedOrderBook` был объявлен как `private`, что недопустимо для типов в пространстве имен.
*   **Вывод:** Ошибка исправлена (изменено на `internal`). Сборка прошла успешно, но основная проблема с подпиской осталась.

### Гипотеза 4 (Текущая): Неправильный WebSocket эндпоинт
*   **Предположение:** Возможно, для публичных данных **спота** используется другой эндпоинт, отличный от `wss://stream.bybit.com/v5/public/spot`, или же для него нужны другие параметры.
*   **Исследование:**
    *   Официальный пример `ws_public_demo.cs` от Bybit использует эндпоинт для **линейных контрактов**: `wss://stream-testnet.bybit.com/v5/public/linear`.
    *   Моя реализация использует эндпоинт для **спота**: `wss://stream.bybit.com/v5/public/spot`.
*   **Вывод:** Это наиболее вероятная причина проблемы. Сервер для спота может иметь другие требования или быть просто не тем сервером, который нужен для получения данных по `HUSDT`.

## 3. Следующие шаги

Необходимо точно определить правильный WebSocket эндпоинт и параметры для подписки на **спотовый** стакан (`orderbook`) для инструмента `HUSDT` через API v5.

1.  Проверить официальную документацию Bybit на предмет наличия разных публичных эндпоинтов для `spot`, `linear`, `inverse`, `option`. **(Выполнено, эндпоинт `.../public/spot` подтвержден как верный)**.
2.  Если эндпоинт `.../public/spot` верен, выяснить, почему он не отвечает на запрос подписки. **(Выполнено, гипотеза об отсутствии `ping` не подтвердилась в C# реализации)**.
3.  Создан и выполнен изолированный Python-скрипт `bybit_ws_bruteforce.py` (`PROPOSAL-2025-0005`). **(Выполнено)**.
    *   **Результат:** Тест подтвердил, что связка (эндпоинт `spot`, топик `orderbook.50.HUSDT`, `ping`-сообщения) **работает**. Проблема окончательно локализована в C# коде.
4.  Выявлена новая причина сбоя: преждевременное завершение работы приложения для `Leg 2` из-за некорректной реализации `ReverseArbitrageTrader.StartAsync`. **(PROPOSAL-2025-0007 был отклонен)**.
5.  **Финальный статус (28.10.2025):** Проблема окончательно локализована. `Leg 2` падает из-за преждевременного завершения `ReverseArbitrageTrader.StartAsync`. Для исправления необходимо применить логику ожидания `TaskCompletionSource`, аналогичную `Leg 1`. Кроме того, в `Leg 1` обнаружена и исправлена ошибка с неверной передачей количества (`quantity` вместо `quoteQuantity`) при продаже на Bybit.

## 4. Итог: Проблема решена

**Статус:** `RESOLVED`

**Причина:** Проблема заключалась не в подписке на WebSocket или формате данных, а в **некорректном управлении жизненным циклом** асинхронной задачи `ReverseArbitrageTrader`. Основной поток приложения завершался раньше, чем `TrailingTrader` для `Leg 2` успевал инициализироваться и получить данные.

**Решение:** Реализовать механизм ожидания завершения (`TaskCompletionSource`) в `ReverseArbitrageTrader`, аналогично тому, как это сделано для `Leg 1`. Это гарантирует, что приложение будет работать до тех пор, пока арбитражный цикл не будет полностью завершен или остановлен вручную.

**Дальнейшие действия:** В ходе тестирования была выявлена новая, менее критичная проблема с минимальным размером ордера. Она отслеживается в [ISSUE-001: Bybit Order Value Limit](ISSUE-001-bybit-order-value.md). Данный документ (`leg2_orderbook_issue_status.md`) считать **архивным**.