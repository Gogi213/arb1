# Логика работы TrailingTrader

## 1. Инициализация

- **Конструктор**: Принимает на вход реализацию интерфейса `IExchange`, который предоставляет доступ к функциям биржи (получение баланса, размещение/отмена ордеров и т.д.).
- **Метод `StartAsync`**:
    - **Начальная настройка**:
        1. Получает текущий баланс в USDT.
        2. Отменяет все существующие открытые ордера для указанного торгового символа, чтобы избежать конфликтов.
    - **Подписка на обновления цены**: Подписывается на получение обновлений цены (лучшей цены покупки - "best bid") для указанного символа. Основная логика трейдера выполняется внутри обработчика этого события.

## 2. Основная логика (выполняется при каждом обновлении цены)

- **Расчет целевой цены**: При каждом получении новой лучшей цены покупки (`bestBidPrice`), вычисляется новая целевая цена для покупки (`newTargetPrice`). Эта цена устанавливается на 1% ниже текущей лучшей цены покупки (`bestBidPrice * 0.99m`). Это и есть "скользящий" (trailing) механизм, который пытается купить актив немного дешевле текущей рыночной цены.

- **Размещение первоначального ордера**:
    - Если ордер еще не был размещен (`_orderId == null`), трейдер:
        1. Рассчитывает количество (`_quantity`) актива для покупки, исходя из общей суммы (`amount`) и новой целевой цены.
        2. Размещает лимитный ордер на покупку по `newTargetPrice`.
        3. Сохраняет ID (`_orderId`) и цену (`_currentOrderPrice`) созданного ордера.
    - Используется блокировка (`_isPlacingOrder`) для предотвращения одновременного размещения нескольких ордеров, если обновления цен приходят слишком быстро.

- **Изменение существующего ордера (Trailing)**:
    - Если ордер уже существует, трейдер:
        1. Сравнивает новую расчетную `newTargetPrice` с ценой текущего ордера `_currentOrderPrice`.
        2. Если цены отличаются, он **изменяет** (перемещает) существующий ордер на новую `newTargetPrice`. Это позволяет ордеру "следовать" за рыночной ценой, всегда оставаясь на 1% ниже нее.
    - Используется блокировка (`_isModifyingOrder`) для предотвращения одновременной отправки нескольких запросов на изменение ордера.

## 3. Завершение работы

- **Длительность**: Метод `StartAsync` содержит `Task.Delay`, который приостанавливает выполнение на указанное количество минут (`durationMinutes`). В течение этого времени бот активно слушает цены и корректирует ордер.
- **Остановка**:
    1. По истечении времени работа трейдера считается завершенной.
    2. Бот отписывается от обновлений цен.
    3. Отменяет последний активный ордер.