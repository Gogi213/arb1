# PROPOSAL-2025-0008: Исправление жизненного цикла Leg 2

## 1. Диагностика

- **Файлы:** `trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs`
- **Проблема:** Метод `StartAsync` в `ReverseArbitrageTrader` является `async Task` и завершается почти сразу после запуска трейлинг-логики, возвращая завершенную задачу. Это приводит к тому, что хост-приложение считает задачу выполненной и немедленно завершает работу, не давая арбитражному циклу `Leg 2` начаться.
- **Серьезность:** `high`

## 2. Предлагаемые изменения

Предлагается изменить `ReverseArbitrageTrader`, чтобы он использовал `TaskCompletionSource` для управления своим жизненным циклом, аналогично `ArbitrageTrader` для `Leg 1`. Это гарантирует, что приложение будет ожидать завершения всего арбитражного цикла.

```diff
--- a/trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs
+++ b/trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs
@@ -31,14 +31,14 @@
  {
  }
 
- public async Task StartAsync(string symbol, decimal amount, int durationMinutes)
+ public Task StartAsync(string symbol, decimal amount, int durationMinutes)
  {
  _symbol = symbol;
  Console.WriteLine($"[Y1] --- Starting ReverseArbitrageTrader for {symbol} ---");
  Console.WriteLine($"[Y1] Buy on: Bybit (low-latency WS), Sell on: {_gateIoExchange.GetType().Name}");
 
  // Subscribe to Gate.io order updates for sell confirmation
- await _gateIoExchange.SubscribeToOrderUpdatesAsync(HandleSellOrderUpdate);
+ _gateIoExchange.SubscribeToOrderUpdatesAsync(HandleSellOrderUpdate);
 
  // Subscribe to fill events from BybitTrailingTrader
  _bybitTrailingTrader.OnOrderFilled += HandleBuyOrderFilled;
@@ -61,7 +61,7 @@
  
  // Cancel all open orders
  Console.WriteLine($"[Y2] Cancelling all open orders for {bybitSymbol}...");
- await _bybitWs.CancelAllOrdersAsync(bybitSymbol);
+ _bybitWs.CancelAllOrdersAsync(bybitSymbol); // Fire-and-forget
  Console.WriteLine("[Y2] All open orders cancelled.");
  Console.WriteLine("[Y2] SETUP complete.\n");
 
@@ -70,17 +70,11 @@
  Console.WriteLine($"[Y3] Starting Bybit trailing for {bybitSymbol}...");
  
  var dollarDepth = 25m; // $25 depth like Gate.io for faster fills in testing
- await _bybitTrailingTrader.StartAsync(bybitSymbol, amount, dollarDepth, _tickSize, _basePrecision);
+ _bybitTrailingTrader.StartAsync(bybitSymbol, amount, dollarDepth, _tickSize, _basePrecision); // Fire-and-forget
  
  Console.WriteLine("[Y3] Bybit trailing started. Waiting for fill event...");
- Console.WriteLine("[Y3] TRAIL complete.\n");
- 
- // TODO Y4-Y7: Handle fill event, market sell, confirmation, cleanup
- Console.WriteLine("[Y3] Y4-Y7 not yet implemented. Will wait for fill event indefinitely for now.");
- 
- // Don't complete immediately - wait for TaskCompletionSource to be set by fill event
- await _arbitrageCycleTcs.Task;
+
+ // Return the task that will be completed when the cycle finishes
+ return _arbitrageCycleTcs.Task;
  }
 
  private async Task CleanupAndSignalCompletionAsync()

```

### Обоснование

Изменение сигнатуры `StartAsync` с `async Task` на `Task` и возврат `_arbitrageCycleTcs.Task` заставляет вызывающий код (в `Program.cs`) ожидать завершения асинхронной операции, управляемой `TaskCompletionSource`. Внутренние `await` заменяются на "fire-and-forget" вызовы, так как их завершение не должно блокировать запуск. Это точная копия работающей логики из `Leg 1`.

## 3. Шаги для отката

Выполнить команду в корне проекта:
`git checkout -- trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs`

## 4. Оценка рисков

- **Риск:** Низкий.
- **Обоснование:** Изменение является исправлением явной ошибки и приводит код в соответствие с уже работающим и протестированным паттерном из `ArbitrageTrader`. Риск регрессии минимален.

## 5. План тестирования

1.  Запустить приложение с активным `Leg 2`.
2.  Убедиться по логам, что приложение не завершается сразу после старта `Leg 2`.
3.  Проверить, что `BybitTrailingTrader` успешно подписывается на стакан и начинает получать данные (в логах должны появиться сообщения о `snapshot` и `delta`).
4.  (Опционально) Спровоцировать исполнение ордера на покупку на Bybit и убедиться, что цикл продолжается: размещается ордер на продажу на Gate.io, и после его исполнения приложение корректно завершает работу через `CleanupAndSignalCompletionAsync`.