# PROPOSAL-2025-0010: Использование реального количества для продажи в Leg 2

## 1. Диагностика

- **Файлы:** `trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs`
- **Проблема:** При попытке разместить рыночный ордер на продажу на Gate.io в рамках `Leg 2`, используется жестко заданное значение `5m` вместо реального количества, полученного при покупке на Bybit. Это приводит к сбою размещения ордера, так как `GateIoExchange` ожидает корректное количество в базовом активе.
- **Серьезность:** `high` (блокирует `Leg 2`)

## 2. Предлагаемые изменения

Предлагается заменить заглушку в методе `HandleBuyOrderFilled` на реальное значение `filledOrder.Quantity`.

```diff
--- a/trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs
+++ b/trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs
@@ -142,8 +142,8 @@
                      ? filledOrder.Symbol.Replace("USDT", "_USDT")
                      : filledOrder.Symbol;
  
-                 // TODO Y5: Determine sell quantity based on Bybit fill
-                 var sellQuantity = 5m; // Placeholder - will use actual filled quantity from Bybit
+                 // Use the actual filled quantity from the Bybit order
+                 var sellQuantity = filledOrder.Quantity;
  
                  var t2 = DateTime.UtcNow;
                  var sellOrderId = await _gateIoExchange.PlaceOrderAsync(

```

### Обоснование

Это изменение исправляет логическую ошибку и позволяет использовать фактическое количество купленных на Bybit токенов для их последующей продажи на Gate.io. Это необходимое условие для корректной работы арбитражного цикла.

## 3. Шаги для отката

Выполнить команду в корне проекта:
`git checkout -- trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs`

## 4. Оценка рисков

- **Риск:** Низкий.
- **Обоснование:** Изменение исправляет очевидную ошибку (использование placeholder'а) и приводит код в соответствие с предполагаемой логикой.

## 5. План тестирования

1.  Запустить приложение с активным `Leg 2`.
2.  Спровоцировать исполнение ордера на покупку на Bybit.
3.  Убедиться по логам, что рыночный ордер на продажу на Gate.io успешно размещается.
4.  Убедиться, что количество в ордере на продажу соответствует количеству, исполненному в ордере на покупку.