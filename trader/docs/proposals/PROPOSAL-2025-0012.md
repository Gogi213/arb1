# PROPOSAL-2025-0012: Исправление адаптера Bybit для использования `cumExecQty`

## 1. Диагностика

- **Файлы:** `trader/src/Exchanges/Bybit/Adapters.cs`
- **Проблема:** `BybitOrderAdapter` использует свойство `_order.Quantity` для получения количества в ордере. Это значение представляет собой *изначально запрошенное* количество. Когда ордер исполняется, более надежным полем является `_order.CumulativeQuantityFilled` (`cumExecQty` в JSON), которое отражает *фактически исполненное* количество. Использование `Quantity` приводит к отправке `0` при попытке продать исполненный ордер, что вызывает ошибку на Gate.io.
- **Серьезность:** `high` (блокирует `Leg 2`)

## 2. Предлагаемые изменения

Предлагается изменить реализацию свойства `Quantity` в `BybitOrderAdapter`, чтобы оно возвращало `_order.CumulativeQuantityFilled`, если оно доступно и больше нуля.

```diff
--- a/trader/src/Exchanges/Bybit/Adapters.cs
+++ b/trader/src/Exchanges/Bybit/Adapters.cs
@@ -18,7 +18,9 @@
  public string Symbol => _order.Symbol;
  public long OrderId => long.Parse(_order.OrderId);
  public decimal Price => _order.Price ?? 0m;
- public decimal Quantity => _order.Quantity;
+        public decimal Quantity => _order.CumulativeQuantityFilled.HasValue && _order.CumulativeQuantityFilled > 0 
+            ? _order.CumulativeQuantityFilled.Value 
+            : _order.Quantity;
  public string Status => _order.Status.ToString();
  public string? FinishType => _order.Status == OrderStatus.Filled ? "Filled" :
                                        _order.Status == OrderStatus.Cancelled ? "Cancelled" : null;

```

### Обоснование

Это изменение гарантирует, что при обработке исполненного ордера (`HandleBuyOrderFilled`) мы будем использовать фактическое количество купленных токенов для создания ордера на продажу. Это исправляет ошибку "order size 0" и является стандартной практикой при работе с биржевыми API.

## 3. Шаги для отката

Выполнить команду в корне проекта:
`git checkout -- trader/src/Exchanges/Bybit/Adapters.cs`

## 4. Оценка рисков

- **Риск:** Низкий.
- **Обоснование:** Изменение улучшает надежность получения данных и исправляет явную ошибку. Оно не должно негативно повлиять на другие части логики.

## 5. План тестирования

1.  Применить изменение.
2.  Запустить приложение с активным `Leg 2`.
3.  Спровоцировать исполнение ордера на покупку на Bybit.
4.  Убедиться по логам, что рыночный ордер на продажу на Gate.io успешно размещается с корректным (не нулевым) количеством.
5.  Убедиться, что цикл `Leg 2` завершается успешно.