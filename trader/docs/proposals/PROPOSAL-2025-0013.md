# PROPOSAL-2025-0013: Тестирование `quoteQuantity` для рыночной продажи на Gate.io

## 1. Диагностика

- **Файлы:** `trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs`
- **Проблема:** Рыночный ордер на продажу на Gate.io завершается с ошибкой `Your order size 0 H is too small`, даже когда передается ненулевое значение в параметре `quantity`.
- **Гипотеза:** Возможно, для рыночной продажи (`Market` + `Sell`) через WebSocket API библиотека `jkorf/GateIo.Net` ожидает количество в котируемой валюте (`USDT`) через параметр `quoteQuantity`, а не в базовой (`H`) через `quantity`.
- **Серьезность:** `high` (блокирует `Leg 2`)

## 2. Предлагаемые изменения

Предлагается временно изменить вызов `PlaceOrderAsync` в `ReverseArbitrageTrader.cs`, чтобы для рыночной продажи передавать `quoteQuantity` вместо `quantity`. Это позволит проверить гипотезу.

```diff
--- a/trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs
+++ b/trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs
@@ -142,14 +142,15 @@
                      ? filledOrder.Symbol.Replace("USDT", "_USDT")
                      : filledOrder.Symbol;
  
-                 // Use the actual filled quantity from the Bybit order
-                 var sellQuantity = filledOrder.Quantity;
+                 // Hypothesis: Gate.io market sell requires quoteQuantity (USDT value) instead of base quantity (H value).
+                 // We will sell slightly less to account for fees and price changes.
+                 var sellQuoteQuantity = 5.0m; // Sell for 5 USDT
  
                  var t2 = DateTime.UtcNow;
                  var sellOrderId = await _gateIoExchange.PlaceOrderAsync(
                      sellSymbol,
                      OrderSide.Sell,
                      NewOrderType.Market,
-                     quantity: sellQuantity);
+                     quoteQuantity: sellQuoteQuantity);
                  var t3 = DateTime.UtcNow;
  
                  var placeOrderLatency = (t3 - t2).TotalMilliseconds;

```

### Обоснование

Это изменение является диагностическим. Если ордер будет успешно размещен, это подтвердит нашу гипотезу о том, что для рыночной продажи на Gate.io через эту библиотеку нужно использовать `quoteQuantity`. Если ордер снова не будет размещен, мы получим новую ошибку, которая поможет нам в дальнейшей диагностике.

## 3. Шаги для отката

Выполнить команду в корне проекта:
`git checkout -- trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs`

## 4. Оценка рисков

- **Риск:** Низкий.
- **Обоснование:** Изменение носит временный и диагностический характер. В худшем случае мы получим другую ошибку, которая даст больше информации.

## 5. План тестирования

1.  Применить изменение.
2.  Запустить приложение с активным `Leg 2`.
3.  Спровоцировать исполнение ордера на покупку на Bybit.
4.  Проанализировать логи и проверить, был ли успешно размещен ордер на продажу на Gate.io.