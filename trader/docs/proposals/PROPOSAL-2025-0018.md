# PROPOSAL-2025-0018: Integrate Quote Quantity into Order Adapters

## 1. Diagnostic
- **Files Affected:**
  - `trader/src/Core/IOrder.cs`
  - `trader/src/Exchanges/GateIo/Adapters.cs`
  - `trader/src/Exchanges/Bybit/Adapters.cs`
  - `trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs`
- **Problem:** The application currently only tracks the filled quantity in the base asset (e.g., `H`). It does not have a standardized way to access the total amount of quote asset (e.g., `USDT`) spent or received in a trade. This complicates PnL calculations and balance tracking.
- **Severity:** `medium`

## 2. Proposed Change Set

### Rationale
The goal is to have a unified way to get the total quote asset value from any executed order, regardless of the exchange. The `jkorf/GateIo.Net` library provides this value directly via the `QuoteQuantityFilled` property. For Bybit, we will calculate it, as their API does not provide it directly.

### Change 1: Update `IOrder.cs`
Add a new property to the common order interface.

```diff
--- a/trader/src/Core/IOrder.cs
+++ b/trader/src/Core/IOrder.cs
@@ -10,6 +10,7 @@
     string Symbol { get; }
     decimal Price { get; }
     decimal Quantity { get; }
+    decimal QuoteQuantity { get; }
     string Status { get; }
     OrderSide Side { get; }
     DateTime Timestamp { get; }

```

### Change 2: Update `GateIoOrderAdapter`
Map the newly identified `QuoteQuantityFilled` property.

```diff
--- a/trader/src/Exchanges/GateIo/Adapters.cs
+++ b/trader/src/Exchanges/GateIo/Adapters.cs
@@ -14,6 +14,7 @@
         public string Symbol => _order.Symbol;
         public decimal Price => _order.AveragePrice ?? 0;
         public decimal Quantity => _order.QuantityFilled;
+        public decimal QuoteQuantity => _order.QuoteQuantityFilled;
         public string Status => _order.Status.ToString().ToLowerInvariant();
         public OrderSide Side => _order.Side == GateIoOrderSide.Buy ? OrderSide.Buy : OrderSide.Sell;
         public DateTime Timestamp => _order.UpdateTime ?? _order.CreateTime;

```

### Change 3: Update Bybit Logic
First, add the average price property to the `BybitOrderUpdate` class.

```diff
--- a/trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs
+++ b/trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs
@@ -260,6 +260,7 @@
             public string Symbol { get; }
             public decimal Price { get; }
             public decimal Quantity { get; }
+            public decimal AveragePrice { get; }
             public decimal CumulativeQuantityFilled { get; }
             public string Status { get; }
             public OrderSide Side { get; }
@@ -276,6 +277,7 @@
                 Status = data.TryGetProperty("orderStatus", out var s) ? s.GetString() : "unknown";
                 Side = data.TryGetProperty("side", out var si) && si.GetString() == "Buy" ? OrderSide.Buy : OrderSide.Sell;
                 Price = data.TryGetProperty("price", out var p) && decimal.TryParse(p.GetString(), out var price) ? price : 0;
+                AveragePrice = data.TryGetProperty("avgPrice", out var ap) && decimal.TryParse(ap.GetString(), out var avgPrice) ? avgPrice : 0;
                 Quantity = data.TryGetProperty("qty", out var q) && decimal.TryParse(q.GetString(), out var qty) ? qty : 0;
                 CumulativeQuantityFilled = data.TryGetProperty("cumExecQty", out var cq) && decimal.TryParse(cq.GetString(), out var cqty) ? cqty : 0;
                 Timestamp = data.TryGetProperty("updatedTime", out var ut) && long.TryParse(ut.GetString(), out var updatedTime) ? DateTimeOffset.FromUnixTimeMilliseconds(updatedTime).DateTime : DateTime.UtcNow;

```

Then, use it in the `BybitOrderAdapter` to calculate the quote quantity.

```diff
--- a/trader/src/Exchanges/Bybit/Adapters.cs
+++ b/trader/src/Exchanges/Bybit/Adapters.cs
@@ -14,6 +14,7 @@
         public string Symbol => _order.Symbol;
         public decimal Price => _order.Price;
         public decimal Quantity => _order.CumulativeQuantityFilled > 0 ? _order.CumulativeQuantityFilled : _order.Quantity;
+        public decimal QuoteQuantity => _order.AveragePrice * Quantity;
         public string Status => _order.Status;
         public OrderSide Side => _order.Side;
         public DateTime Timestamp => _order.Timestamp;

```

## 3. Rollback Steps
- Revert the changes in the affected files using `git checkout`.

## 4. Risk Assessment
- **Low.** The changes are additive or modify internal adapter logic. The core trading logic is not affected. The main risk is an incorrect calculation for Bybit, which will be immediately obvious from the logs.

## 5. Testing Plan
- After applying the changes, run the bot for both `Leg 1` and `Leg 2`.
- Check the logs to ensure that after a fill, the calculated PnL correctly uses the new `QuoteQuantity` value.
- Manually verify that `Gate.io QuoteQuantity` matches the trade history on the exchange website.
- Manually verify that `Bybit QuoteQuantity` (`AveragePrice * Quantity`) is approximately correct.