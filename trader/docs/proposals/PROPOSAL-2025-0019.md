# PROPOSAL-2025-0019: Refactor Bybit Adapter to Use `cumExecValue`

## 1. Diagnostic
- **Files Affected:**
  - `trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs`
- **Problem:** The `BybitOrderUpdate` class currently calculates the `QuoteQuantity` by multiplying `AveragePrice` by `CumulativeQuantityFilled`. Analysis of new logs reveals that the Bybit WebSocket API provides this value directly in the `cumExecValue` field. Using the direct value is more accurate and robust.
- **Severity:** `low`

## 2. Proposed Change Set

### Rationale
To improve accuracy and simplify the code, we will switch from a calculated `QuoteQuantity` to using the `cumExecValue` field provided by the exchange. This eliminates potential floating-point inaccuracies and makes the code's intent clearer.

### Change: Update `BybitOrderUpdate` in `BybitLowLatencyWs.cs`
We will replace the `AveragePrice` property with `cumExecValue` and use it directly for `QuoteQuantity`.

```diff
--- a/trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs
+++ b/trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs
@@ -666,13 +666,12 @@
     public class BybitOrderUpdate : IOrder
     {
         public string Symbol { get; }
-        public long OrderId { get; }
         public decimal Price { get; }
-        public decimal AveragePrice { get; }
         public decimal Quantity { get; }
         public decimal CumulativeQuantityFilled { get; }
         public decimal QuoteQuantity { get; }
         public string Status { get; }
+        public long OrderId { get; }
         public string? FinishType { get; }
         public DateTime? CreateTime { get; }
         public DateTime? UpdateTime { get; }
@@ -680,12 +679,11 @@
         public BybitOrderUpdate(JsonElement data)
         {
             Symbol = data.TryGetProperty("symbol", out var sym) ? sym.GetString() ?? "" : "";
-            OrderId = data.TryGetProperty("orderId", out var oid) ? long.Parse(oid.GetString() ?? "0") : 0;
             Price = data.TryGetProperty("price", out var pr) && decimal.TryParse(pr.GetString(), out var price) ? price : 0;
-            AveragePrice = data.TryGetProperty("avgPrice", out var ap) && decimal.TryParse(ap.GetString(), out var avgPrice) ? avgPrice : 0;
             Quantity = data.TryGetProperty("qty", out var q) && decimal.TryParse(q.GetString(), out var qty) ? qty : 0;
             CumulativeQuantityFilled = data.TryGetProperty("cumExecQty", out var cq) && decimal.TryParse(cq.GetString(), out var cqty) ? cqty : 0;
-            QuoteQuantity = AveragePrice * CumulativeQuantityFilled;
+            QuoteQuantity = data.TryGetProperty("cumExecValue", out var cev) && decimal.TryParse(cev.GetString(), out var ceValue) ? ceValue : 0;
             Status = data.TryGetProperty("orderStatus", out var st) ? st.GetString() ?? "" : "";
+            OrderId = data.TryGetProperty("orderId", out var oid) ? long.Parse(oid.GetString() ?? "0") : 0;
             FinishType = Status == "Filled" ? "Filled" : Status == "Cancelled" ? "Cancelled" : null;
 
             if (data.TryGetProperty("createdTime", out var ct) && long.TryParse(ct.GetString(), out var createMs))

```

## 3. Rollback Steps
- Revert the changes in `trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs` using `git checkout`.

## 4. Risk Assessment
- **Very Low.** This change replaces a calculation with a more direct and accurate value from the source. The logic becomes simpler and more robust.

## 5. Testing Plan
- After applying the change, run the bot.
- Verify from the logs that the application starts and runs without compilation or runtime errors related to order processing.
- Manually check if the PnL calculations (if any are logged) seem correct.