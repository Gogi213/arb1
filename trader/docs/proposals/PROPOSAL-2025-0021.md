# PROPOSAL-2025-0021: Standardize Order Quantity to Base Asset

## 1. Diagnostic
- **Files Affected:**
  - `trader/src/Core/ArbitrageTrader.cs`
  - `trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs`
  - `trader/src/Exchanges/Bybit/BybitExchange.cs`
- **Problem:** As detailed in `quantity_flow_analysis.md`, the system uses inconsistent units for order placement. `ArbitrageTrader` (Leg 1) incorrectly places a sell order on Bybit using a fixed amount of **quote currency** (`USDT`), ignoring the actual amount of **base currency** (`H`) purchased on Gate.io. This creates a fundamental flaw in the arbitrage logic.
- **Severity:** `critical`

## 2. Proposed Change Set

### Rationale
To ensure the integrity of the arbitrage cycle, all order placements must be standardized to use the **base asset quantity**. This change will make `ArbitrageTrader` (Leg 1) behave correctly, mirroring the already-correct logic of `ReverseArbitrageTrader` (Leg 2). We will remove the ability to place market orders by quote currency from our Bybit implementation to enforce this standard.

### Change 1: Unify `ArbitrageTrader` (Leg 1) Logic
Modify the sell leg to use the exact `Quantity` from the filled buy order, just like in `ReverseArbitrageTrader`.

```diff
--- a/trader/src/Core/ArbitrageTrader.cs
+++ b/trader/src/Core/ArbitrageTrader.cs
@@ -87,14 +87,12 @@
  
                  // Bybit uses a different symbol format (without underscore)
                  var sellSymbol = filledOrder.Symbol.Replace("_", "");
-                 var sellAmountUsd = 5m; // Minimum for Bybit spot market order
  
                  var t2 = DateTime.UtcNow;
                  var sellOrderId = await _sellExchange.PlaceOrderAsync(
                      sellSymbol,
                      OrderSide.Sell,
                      NewOrderType.Market,
-                     quoteQuantity: sellAmountUsd);
+                     quantity: filledOrder.Quantity); // USE BASE ASSET QUANTITY
                  var t3 = DateTime.UtcNow;
  
                  var placeOrderLatency = (t3 - t2).TotalMilliseconds;

```

### Change 2: Remove Quote-Based Market Orders from Bybit
Modify `BybitLowLatencyWs.cs` to only accept base asset quantity for market orders. This makes the implementation stricter and safer.

```diff
--- a/trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs
+++ b/trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs
@@ -115,7 +115,7 @@
              await SendMessageAsync(ws, sendLock, pingMessage, name);
          }
      
-         public async Task<string?> PlaceMarketOrderAsync(string symbol, string side, decimal quoteQuantity)
+         public async Task<string?> PlaceMarketOrderAsync(string symbol, string side, decimal quantity)
          {
              if (!_isTradeAuthenticated)
                  throw new InvalidOperationException("Trade WebSocket is not authenticated");
@@ -138,10 +138,10 @@
              }
  
              // Format quantity without trailing zeros - use InvariantCulture for dot separator
-             var qtyStr = quoteQuantity.ToString("0.########", CultureInfo.InvariantCulture);
+             var qtyStr = quantity.ToString("0.########", CultureInfo.InvariantCulture);
  
              // Build JSON with proper Bybit v5 format
-             var orderMessage = $@"{{""reqId"":""{reqId}"",""header"":{{""X-BAPI-TIMESTAMP"":""{timestamp}"",""X-BAPI-RECV-WINDOW"":""5000""}},""op"":""order.create"",""args"":[{{""category"":""spot"",""symbol"":""{symbol}"",""side"":""{side}"",""orderType"":""Market"",""qty"":""{qtyStr}"",""marketUnit"":""quoteCoin""}}]}}";
+             var orderMessage = $@"{{""reqId"":""{reqId}"",""header"":{{""X-BAPI-TIMESTAMP"":""{timestamp}"",""X-BAPI-RECV-WINDOW"":""5000""}},""op"":""order.create"",""args"":[{{""category"":""spot"",""symbol"":""{symbol}"",""side"":""{side}"",""orderType"":""Market"",""qty"":""{qtyStr}""}}]}}";
  
              var t0 = DateTime.UtcNow;
              await SendMessageAsync(_tradeWs, _tradeSendLock, orderMessage, "TRADE");

```

### Change 3: Update `BybitExchange` Wrapper
Update the wrapper method to reflect the change made in `BybitLowLatencyWs`.

```diff
--- a/trader/src/Exchanges/Bybit/BybitExchange.cs
+++ b/trader/src/Exchanges/Bybit/BybitExchange.cs
@@ -53,7 +53,10 @@
          {
              if (_lowLatencyWs == null) throw new InvalidOperationException("Client not initialized");
  
-             var orderQuantity = type == Core.NewOrderType.Market ? quoteQuantity : quantity;
+             // Standardize to always use base quantity. Quote quantity is no longer supported for market orders.
+             var orderQuantity = quantity;
              if (orderQuantity == null)
              {
                  throw new ArgumentNullException(nameof(quantity), "Order quantity must be provided.");

```

## 3. Rollback Steps
- Revert the changes in the affected files using `git checkout`.

## 4. Risk Assessment
- **Low.** This change corrects a fundamental logic flaw and standardizes behavior across the application, making it more robust and predictable.

## 5. Testing Plan
- Run `Leg 1`. Verify from the logs that the quantity passed to the sell order on Bybit exactly matches the `cumExecQty` from the buy order on Gate.io.
- Run `Leg 2`. Verify that its behavior remains correct.