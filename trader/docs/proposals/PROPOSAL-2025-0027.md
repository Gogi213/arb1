# PROPOSAL-2025-0027: Fix Leg 2 Quantity Calculation in BybitTrailingTrader

## 1. Diagnostic

- **Files Affected:**
  - `trader/src/Exchanges/Bybit/BybitTrailingTrader.cs`
- **Problem:** Following the implementation of `PROPOSAL-2025-0026`, the `BybitTrailingTrader` in `Leg 2` now receives the desired **base asset quantity** (e.g., 20 `H`) in its `amount` parameter. However, it still incorrectly treats this `amount` as a **quote asset value** (e.g., 20 `USDT`) and performs a division by price (`amount / newTargetPrice`) to calculate the order quantity. This results in a massively inflated, incorrect quantity, which is then rejected by the Bybit API with an "Insufficient balance" error.
- **Severity:** `critical`

## 2. Proposed Change Set

### Rationale
The fix is to align the logic inside `BybitTrailingTrader` with the new data flow. Since the `amount` parameter now represents the exact base quantity to be traded, the division by price is not only unnecessary but incorrect. The proposed change removes this calculation and uses the `amount` value directly as the order quantity.

### Change 1: Correct Quantity Assignment in `BybitTrailingTrader.cs`
Update the order placement logic to use the `amount` parameter directly.

```diff
--- a/trader/src/Exchanges/Bybit/BybitTrailingTrader.cs
+++ b/trader/src/Exchanges/Bybit/BybitTrailingTrader.cs
@@ -75,7 +75,7 @@
                      if (_orderId == null)
                      {
                          FileLogger.LogOther($"[BybitTrailing] Best Bid: {bestBid:F5}. Placing BUY order at {newTargetPrice:F5}");
-                         _quantity = Math.Round(amount / newTargetPrice, _basePrecision);
+                         _quantity = Math.Round(amount, _basePrecision);
  
                          var placedOrderIdStr = await _ws.PlaceLimitOrderAsync(symbol, "Buy", _quantity, newTargetPrice);
  

```

## 3. Rollback Steps
- Revert the change in `trader/src/Exchanges/Bybit/BybitTrailingTrader.cs` using `git checkout .`.

## 4. Risk Assessment
- **Low.** This is a highly targeted fix for a clear logical bug introduced by the previous change. It corrects the quantity calculation to match the new data flow and should unblock `Leg 2` execution. No other part of the system is affected.

## 5. Testing Plan
1. Run the application.
2. Verify from `trader/logs/websocket.txt` that the `order.create` request for `Leg 2` on Bybit now contains the correct quantity (e.g., `"qty":"20"`) instead of the previously incorrect calculated value (e.g., `"qty":"67"`).
3. Confirm that the limit order on Bybit is placed successfully and that the `Leg 2` cycle proceeds without "Insufficient balance" errors.