# PROPOSAL-2025-0028: Спринт 1 - Убрать передачу объема Bybit -> Gate.io

## 1. Диагностика

- **Файлы:** `trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs`
- **Проблема:** Внутри `Leg 2` (`ReverseArbitrageTrader`), количество, фактически купленное на Bybit, напрямую используется для размещения ордера на продажу на Gate.io. Из-за различий в правилах округления и точности (`precision`) между биржами, это приводит к ошибке `BALANCE_NOT_ENOUGH` на Gate.io, так как передаваемое количество может не соответствовать правилам биржи.
- **Серьезность:** `High`

## 2. Предлагаемые изменения

### Цель: Разорвать связь Bybit -> Gate.io внутри Leg 2

В файле `trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs` необходимо изменить метод `HandleBuyOrderFilled`. Вместо того чтобы использовать `filledOrder.Quantity`, мы временно будем использовать жестко закодированное значение, соответствующее `Amount` из конфигурации. Это подготовительный шаг для Спринта 2.

```diff
--- a/trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs
+++ b/trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs
@@ -87,11 +87,14 @@
             FileLogger.LogOther($"[Y4] Buy fill server time: {_buyOrderFilledTime:HH:mm:ss.fff}, Handler entered: {DateTime.UtcNow:HH:mm:ss.fff}");
             FileLogger.LogOther($"[Latency] WS propagation delay (Bybit fill -> handler): {(DateTime.UtcNow - _buyOrderFilledTime).TotalMilliseconds:F0}ms");
 
-            var sellQuantity = _gateIoExchange.RoundQuantity(filledOrder.Symbol, filledOrder.Quantity);
+            // var sellQuantity = _gateIoExchange.RoundQuantity(filledOrder.Symbol, filledOrder.Quantity);
+            // ВРЕМЕННО: Используем исходное количество из конфига, чтобы разорвать связь.
+            // В Спринте 2 здесь будет логика получения количества из Leg 1 (Gate.io).
+            var sellQuantity = _gateIoExchange.RoundQuantity(filledOrder.Symbol, _amount);
 
             FileLogger.LogOther($"[Y4] FILL complete. Trigger: Place market SELL on Gate.io");
             FileLogger.LogOther($"[Y5] --- MARKET Phase ---");
-            FileLogger.LogOther($"[Y5] Immediately selling {sellQuantity} on GateIoExchange (original from Bybit: {filledOrder.Quantity}).");
+            FileLogger.LogOther($"[Y5] Immediately selling {sellQuantity} on GateIoExchange (using initial amount {_amount}).");
 
             var sellOrder = await _gateIoExchange.PlaceOrderAsync(
                 filledOrder.Symbol,

```

## 3. Обоснование

Это изменение является первым шагом к реализации "идеального свопа" на Gate.io. Мы устраняем основную причину ошибки `BALANCE_NOT_ENOUGH`, разрывая некорректную передачу объема между разными биржами внутри одного арбитражного плеча.

Этот шаг необходим для **Спринта 2**, где на место временного решения будет добавлена логика получения объема с первой покупки на Gate.io (`Leg 1`).

## 4. Шаги для отката

`git checkout -- trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs`

## 5. Оценка рисков

- **Риск:** Низкий.
- **Обоснование:** Продажа в `Leg 2` и так не работает стабильно. Это изменение делает поведение предсказуемым (оно будет падать с той же ошибкой, но по понятной причине) и подготавливает код к следующему этапу.

## 6. План тестирования

1.  Применить изменение.
2.  Запустить приложение.
3.  Убедиться по логам, что в `[Y5]` `ReverseArbitrageTrader` пытается продать количество, основанное на `_amount` из конфигурации, а не на `filledOrder.Quantity` из Bybit.