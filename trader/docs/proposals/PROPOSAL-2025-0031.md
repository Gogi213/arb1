# PROPOSAL-2025-0031: Исправление некорректного округления в ReverseArbitrageTrader

## 1. Диагностика

- **Затронутые файлы:** `trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs`
- **Проблема:** `ReverseArbitrageTrader` (Leg 2) падает с ошибкой `BALANCE_NOT_ENOUGH` при продаже на Gate.io. Причина в том, что он использует `_gateIoExchange.RoundQuantity`, который имеет жестко заданную точность в 2 знака. Это неправильно округляет точное количество, полученное из Leg 1 (например, `20.55817` становится `20.56`), делая его больше доступного баланса.
- **Критичность:** `высокая`

## 2. Предлагаемое изменение

Решение состоит в том, чтобы заменить неверную логику округления на метод, который **усекает (truncate)** количество до необходимого числа знаков после запятой (`_sellBasePrecision`). Это гарантирует, что количество для продажи никогда не будет превышать доступный баланс.

```diff
--- a/trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs
+++ b/trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs
@@ -148,9 +148,10 @@
                  // Use the actual filled quantity from the Bybit order
                  // var sellQuantity = Math.Round(filledOrder.Quantity, _sellBasePrecision);
                  // Используем количество, сохраненное из Leg 1
-                 var sellQuantity = _gateIoExchange.RoundQuantity(filledOrder.Symbol, _state.GateIoLeg1BuyQuantity);
+                 decimal factor = (decimal)Math.Pow(10, _sellBasePrecision);
+                 var sellQuantity = Math.Truncate(_state.GateIoLeg1BuyQuantity * factor) / factor;
                  FileLogger.LogOther($"[Y5] Immediately selling {sellQuantity} on GateIoExchange (original from Gate.io Leg 1: {_state.GateIoLeg1BuyQuantity}).");
  
                  var t2 = DateTime.UtcNow;

```

## 3. Шаги для отката

1.  Вернуть изменения в файле `trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs` к предыдущей версии с помощью `git checkout -- trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs`.

## 4. Оценка рисков

- **Риск:** Очень низкий. Это изменение исправляет очевидную логическую ошибку, используя усечение — самый безопасный способ обработки количества для продажи, чтобы избежать ошибок `BALANCE_NOT_ENOUGH`.

## 5. План тестирования

1.  Запустить полный цикл арбитража.
2.  **Проверить логи:**
    - В логе `[Y5]` для `ReverseArbitrageTrader` убедиться, что количество для продажи теперь корректно **усекается** (например, `20.55817` станет `20.55`, если точность равна 2).
    - Убедиться, что рыночный ордер на продажу на Gate.io во второй части цикла (Leg 2) выполняется успешно, без ошибки `BALANCE_NOT_ENOUGH`.
3.  **Конечное состояние:** Весь цикл арбитража должен завершиться успешно.
