# PROPOSAL-2025-0037: Реализация полностью замкнутого балансового цикла

- **Severity:** High
- **Author:** Kilo Code
- **Date:** 2025-10-29

---

## Диагностика

**Проблема:** Текущий арбитражный цикл не является полностью замкнутым и автоматизированным. Передача средств между `Leg 1` и `Leg 2` происходит на основе приблизительных данных (`order.Quantity`), а не на основе фактических, пост-комиссионных балансов. `Leg 2` также логически зависим от `Leg 1`.

**Цель:** Реализовать полностью автоматизированный, симметричный и замкнутый цикл, где выход каждой операции (фактический баланс) становится входом для следующей.

---

## Предлагаемое изменение

Внедрить механизм отслеживания и передачи баланса на всех этапах цикла.

**План реализации:**

1.  **Модифицировать `ArbitrageTrader` (Leg 1):**
    *   После рыночной продажи на Bybit, не завершать цикл сразу.
    *   Добавить механизм `debouncing` для отслеживания **баланса `USDT`** на Bybit.
    *   Дождаться стабилизации баланса `USDT` после продажи.
    *   Вернуть из `StartAsync` точное, финальное количество `USDT`.

2.  **Модифицировать `ReverseArbitrageTrader` (Leg 2):**
    *   **Убрать зависимость от `_state`:** Полностью удалить использование `_state.GateIoLeg1BuyQuantity`.
    *   **Использовать точный баланс для покупки:** Принимаемый в `StartAsync` параметр `amount` теперь будет точным балансом `USDT` с `Leg 1`. Использовать его для расчета объема покупки на Bybit.
    *   **Добавить отслеживание баланса `H`:** После покупки на Bybit, добавить механизм `debouncing` для отслеживания **баланса `H`** на Bybit.
    - **Использовать точный баланс для продажи:** Дождаться стабилизации баланса `H` и использовать это фактическое количество для рыночной продажи на Gate.io.

3.  **Модифицировать `BybitExchange.cs`:**
    *   Реализовать `SubscribeToBalanceUpdatesAsync`, если он отсутствует или неполон, чтобы обеспечить получение обновлений по `USDT` и `H`.

4.  **Модифицировать `Program.cs`:**
    *   Логика остается прежней, но теперь `leg1SellQuantity` будет содержать точный баланс `USDT`, а не примерное количество.

---

## Обоснование

Эти изменения превратят систему из двух полу-независимых скриптов в единый, полностью автоматизированный конвейер.
-   **Точность:** Каждая операция будет основана на реальных, пост-комиссионных данных, что исключит ошибки `BALANCE_NOT_ENOUGH` и дисбаланс активов.
-   **Надежность:** Система станет более предсказуемой и устойчивой.
-   **Автономность:** Устраняется необходимость в ручной корректировке объемов между циклами.

---

## Оценка рисков

-   **Риск:** Сложность реализации. Задача затрагивает оба трейдера и требует аккуратной работы с асинхронным кодом.
    -   **Митигация:** Мы будем использовать уже отлаженный паттерн `debouncing` из `ArbitrageTrader`, что снижает риск. Изменения будут вноситься пошагово.

---

## План тестирования

1.  Запустить полный цикл `Leg 1 -> Leg 2`.
2.  **Проверить логи `Leg 1`:** Убедиться, что после продажи на Bybit происходит ожидание и фиксация точного баланса `USDT`.
3.  **Проверить логи `Leg 2`:** Убедиться, что:
    -   Для покупки на Bybit используется точный баланс `USDT` из `Leg 1`.
    -   После покупки на Bybit происходит ожидание и фиксация точного баланса `H`.
    -   Для продажи на Gate.io используется этот точный баланс `H`.
4.  Убедиться, что весь цикл проходит без ошибок.

---

## План отката

1.  Вернуть изменения в `ArbitrageTrader.cs`, `ReverseArbitrageTrader.cs`, `BybitExchange.cs` и `Program.cs` из системы контроля версий.
