# PROPOSAL-2025-0038: Использование единого экземпляра BybitExchange

- **Severity:** High
- **Author:** Kilo Code
- **Date:** 2025-10-30

---

## Диагностика

**Проблема:** `Leg 2` не может размещать ордера на Bybit. Анализ показал, что в `Program.cs` создается второй, отдельный экземпляр `BybitLowLatencyWs` специально для `Leg 2`. Это приводит к конфликту WebSocket-соединений, так как Bybit, вероятно, не разрешает несколько одновременных торговых сессий для одного API-ключа. В результате второе соединение не может отправлять команды.

**Цель:** Рефакторинг `Program.cs` для использования **единого** экземпляра `BybitExchange` (и, следовательно, `BybitLowLatencyWs`) для обеих "ног" арбитража.

---

## Предлагаемое изменение

1.  **Изменить `ReverseArbitrageTrader`:**
    *   Конструктор должен принимать `IExchange` вместо `BybitLowLatencyWs`. Это сделает его более универсальным и соответствующим `ArbitrageTrader`.
    *   Внутренняя логика должна использовать `IExchange` для всех операций (подписки, размещение ордеров).

2.  **Изменить `Program.cs`:**
    *   Удалить создание нового `BybitLowLatencyWs` для `Leg 2`.
    *   Передавать в конструктор `ReverseArbitrageTrader` тот же самый экземпляр `bybitExchange`, который использовался для `Leg 1`.

---

## Обоснование

-   **Устранение конфликта:** Использование одного экземпляра решит проблему с конфликтом WebSocket-соединений.
-   **Корректность архитектуры:** Это соответствует принципу DRY (Don't Repeat Yourself) и делает архитектуру более чистой и предсказуемой. Оба трейдера должны работать с одним и тем же представлением биржи.
-   **Унификация:** `ReverseArbitrageTrader` станет более похожим на `ArbitrageTrader`, что упростит его понимание и поддержку.

---

## Оценка рисков

-   **Риск:** Минимальный. Мы заменяем создание нового объекта на переиспользование существующего, что является упрощением, а не усложнением.

---

## План тестирования

1.  Применить изменения.
2.  Запустить полный цикл `Leg 1 -> Leg 2`.
3.  **Проверить логи `Leg 2`:** Убедиться, что ошибки `> Failed to place order.` исчезли.
4.  Убедиться, что `BybitTrailingTrader` в `Leg 2` успешно размещает и модифицирует ордер на покупку.
5.  Убедиться, что весь цикл завершается (хотя бы доходит до следующего логического шага или ошибки).

---

## План отката

1.  Вернуть изменения в `ReverseArbitrageTrader.cs` и `Program.cs` из системы контроля версий.
