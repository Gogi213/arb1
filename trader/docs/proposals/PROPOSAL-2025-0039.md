# PROPOSAL-2025-0039: Fix Orchestrator and Clarify Leg 2 Logic

## 1. Compact Diagnostic

The system fails in `Leg 2` due to two issues identified in `ISSUE-005`:
1.  **Orchestrator Bug:** The `amount` from `Leg 1`'s execution (`10.53 USDT`) is not passed to `Leg 2`. Instead, a hardcoded value from `appsettings.json` (`6 USDT`) is used.
2.  **Logic Flaw:** The system attempts to sell assets on Gate.io that were just purchased on Bybit, causing a failure because the assets are not on the correct exchange.

This proposal addresses the first issue directly and seeks clarification on the second.

## 2. Proposed Change

### File: `trader/src/Host/Program.cs`

The change involves replacing the hardcoded `bybitConfig.Amount` with the actual result from `Leg 1` (`leg1SellQuantity`).

```diff
<<<<<<< SEARCH
:start_line:52
-------
                await reverseArbitrageTrader.StartAsync(bybitConfig.Symbol, bybitConfig.Amount, bybitConfig.DurationMinutes, cycleState);
=======
                await reverseArbitrageTrader.StartAsync(bybitConfig.Symbol, leg1SellQuantity, bybitConfig.DurationMinutes, cycleState);
>>>>>>> REPLACE
```

## 3. Rationale

This change fixes the bug where the output of `Leg 1` was ignored. By passing `leg1SellQuantity` to `reverseArbitrageTrader`, we ensure that `Leg 2` operates with the actual capital resulting from the first part of the cycle, thus correctly implementing the "closed-loop" principle for capital flow.

## 4. Risk Assessment

- **Risk:** Low. This is a direct bug fix that aligns the code with its intended logic.
- **Mitigation:** The change is minimal and localized to the orchestrator.

## 5. **CRITICAL: Required Clarification on Leg 2 Logic**

Even after applying the fix above, the cycle **will still fail**.

The current logic is:
1.  `Leg 2` buys Asset `H` on **Bybit**.
2.  The system immediately tries to sell Asset `H` on **Gate.io**.

This fails because the asset is on Bybit. The logic described by the user is: *"снепшот баланса гейт идйт в маркет сел гейт"* (snapshot of Gate.io balance goes to market sell on Gate.io).

This implies we should be selling an asset that is already on Gate.io.

**Please clarify the intended logic for the final step:**

-   **Option A:** Should we simulate the cycle by pre-funding the Gate.io account with Asset `H` and then sell that? This would test the PnL calculation of a full theoretical cycle.
-   **Option B:** Should `Leg 2`'s sell action be on **Bybit** instead of Gate.io? (e.g., buy on Bybit, then immediately sell on Bybit if conditions are met).
-   **Option C:** Is there another interpretation of the logic that has been missed?

**The code cannot be fully fixed until this logical ambiguity is resolved.**

## 6. Testing Plan

1.  Approve and apply the diff.
2.  Run the application.
3.  **Expected outcome:** The application will now start `Leg 2` with the correct amount (`~10.53 USDT`). It will then proceed to the `Y5` phase and fail on the Gate.io market sell, as expected, pending the logic clarification.

## 7. Rollback Steps

-   Revert the change in `trader/src/Host/Program.cs`.