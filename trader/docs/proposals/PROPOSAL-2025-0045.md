# PROPOSAL-2025-0045: Fix CumulativeQuoteQuantity Parsing in BybitOrderUpdate

## 1. Диагностика

После применения `PROPOSAL-2025-0044`, `ArbitrageTrader` начал использовать `order.CumulativeQuoteQuantity` для определения выручки. Однако, логи показали, что это свойство всегда возвращает `0`.

Анализ исходного кода `BybitLowLatencyWs.cs` выявил ошибку в конструкторе класса `BybitOrderUpdate`. Свойство `CumulativeQuoteQuantity` не парсилось напрямую из JSON-сообщения от WebSocket, а просто копировало значение другого свойства, которое на тот момент еще не было инициализировано корректно в рамках логики `IOrder`.

## 2. Предлагаемое изменение

Это изменение исправляет логику парсинга в конструкторе `BybitOrderUpdate`, заставляя его корректно считывать значение `cumExecValue` из JSON и присваивать его свойству `CumulativeQuoteQuantity`.

### `trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs`

```diff
<<<<<<< SEARCH
:start_line:737
-------
            QuoteQuantity = CumulativeExecutedValue;
            CumulativeQuoteQuantity = CumulativeExecutedValue;
=======
            QuoteQuantity = data.TryGetProperty("cumExecValue", out var ceq) && decimal.TryParse(ceq.GetString(), out var ceqValue) ? ceqValue : 0;
            CumulativeQuoteQuantity = data.TryGetProperty("cumExecValue", out var cev) && decimal.TryParse(cev.GetString(), out var ceValue) ? ceValue : 0;
>>>>>>> REPLACE
```

## 3. Обоснование

Это исправление критически важно для корректной работы всего арбитражного цикла. Оно обеспечивает, что точное значение выручки от продажи (`cumExecValue`) будет правильно распарсено и передано в `ArbitrageTrader`, что, в свою очередь, позволит `ReverseArbitrageTrader` (Leg 2) оперировать правильной суммой USDT. Это должно окончательно решить проблему `Insufficient balance`.

## 4. Оценка рисков

-   **Риск:** Минимальный. Изменение затрагивает только одну строку в логике парсинга и приводит ее в соответствие с фактическими данными, присылаемыми биржей.
-   **Смягчение:** Легко проверяется анализом логов.

## 5. План тестирования

1.  Утвердить и применить изменение.
2.  Запустить сборку проекта.
3.  Запустить приложение.
4.  **Ожидаемый результат:**
    *   В логе `other.txt` строка `[Arbitrage] Sale executed. USDT proceeds from order.CumulativeQuoteQuantity:` должна содержать корректное, ненулевое значение (например, `6.007260`).
    *   `Orchestrator` должен запустить Leg 2 с этой суммой.
    *   Ошибки `Insufficient balance` должны полностью исчезнуть.

## 6. План отката

-   Восстановить предыдущую версию файла `trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs`.