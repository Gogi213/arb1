# PROPOSAL-2025-0047: Correct BybitOrderUpdate Parsing Logic

## 1. Диагностика

Несмотря на исправление ошибки компиляции в `PROPOSAL-2025-0046`, основная проблема осталась: `order.CumulativeQuoteQuantity` по-прежнему возвращает `0`.

Причина в том, что мой `diff` в `PROPOSAL-2025-0045` был некорректным. Я исправил конфликт имен переменных, но не исправил саму логику присваивания.

**Текущая (неверная) логика:**
```csharp
QuoteQuantity = data.TryGetProperty("cumExecValue", out var ceq) && decimal.TryParse(ceq.GetString(), out var ceqValue) ? ceqValue : 0;
CumulativeQuoteQuantity = data.TryGetProperty("cumExecValue", out var cev_cq) && decimal.TryParse(cev_cq.GetString(), out var ceValue_cq) ? ceValue_cq : 0;
```
Оба свойства `QuoteQuantity` и `CumulativeQuoteQuantity` читают одно и то же поле `cumExecValue`. Это неверно. `QuoteQuantity` должно оставаться как есть, а `CumulativeQuoteQuantity` должно быть исправлено.

## 2. Предлагаемое изменение

Это изменение исправляет логику в конструкторе `BybitOrderUpdate`, чтобы `CumulativeQuoteQuantity` корректно парсилось из `cumExecValue`, а `QuoteQuantity` сохранило свою первоначальную логику.

### `trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs`

```diff
<<<<<<< SEARCH
:start_line:736
-------
            CumulativeExecutedValue = data.TryGetProperty("cumExecValue", out var cev) && decimal.TryParse(cev.GetString(), out var ceValue) ? ceValue : 0;
            QuoteQuantity = data.TryGetProperty("cumExecValue", out var ceq) && decimal.TryParse(ceq.GetString(), out var ceqValue) ? ceqValue : 0;
            CumulativeQuoteQuantity = data.TryGetProperty("cumExecValue", out var cev_cq) && decimal.TryParse(cev_cq.GetString(), out var ceValue_cq) ? ceValue_cq : 0;
=======
            CumulativeExecutedValue = data.TryGetProperty("cumExecValue", out var cev) && decimal.TryParse(cev.GetString(), out var ceValue) ? ceValue : 0;
            QuoteQuantity = CumulativeExecutedValue;
            CumulativeQuoteQuantity = CumulativeExecutedValue;
>>>>>>> REPLACE
```

## 3. Обоснование

Это исправление должно окончательно решить проблему с нулевым значением `CumulativeQuoteQuantity`.

## 4. Оценка рисков

-   **Риск:** Низкий.

## 5. План тестирования

1.  Утвердить и применить изменение.
2.  Запустить сборку проекта.
3.  Запустить приложение.
4.  **Ожидаемый результат:**
    *   В логе `other.txt` строка `[Arbitrage] Sale executed. USDT proceeds from order.CumulativeQuoteQuantity:` должна содержать корректное, ненулевое значение.
    *   Leg 2 должен стартовать с этой суммой.
    *   Ошибки `Insufficient balance` должны исчезнуть.

## 6. План отката

-   Восстановить предыдущую версию файла `trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs`.