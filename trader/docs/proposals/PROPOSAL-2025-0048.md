# PROPOSAL-2025-0048: Final Fix for BybitOrderUpdate Parsing

## 1. Диагностика

Мой предыдущий пропозал (`PROPOSAL-2025-0047`) был некорректен и возвращал код к состоянию, которое уже было признано ошибочным.

Проблема остается прежней: `order.CumulativeQuoteQuantity` возвращает `0`, потому что логика парсинга в конструкторе `BybitOrderUpdate` неверна. Ошибка `CS0128` (дублирование переменных) из-за моего неудачного исправления в `PROPOSAL-2025-0045` также актуальна.

## 2. Предлагаемое изменение

Это изменение **корректно** исправляет логику парсинга в конструкторе `BybitOrderUpdate`.

1.  `CumulativeExecutedValue` и `CumulativeQuoteQuantity` оба парсятся из `cumExecValue`.
2.  `QuoteQuantity` возвращается к своей исходной логике (копирует `CumulativeExecutedValue`), что является приемлемым для рыночного ордера, где начальная `QuoteQuantity` не определена.
3.  Конфликт имен переменных, вызвавший ошибку компиляции, устранен.

### `trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs`

```diff
<<<<<<< SEARCH
:start_line:736
-------
            CumulativeExecutedValue = data.TryGetProperty("cumExecValue", out var cev) && decimal.TryParse(cev.GetString(), out var ceValue) ? ceValue : 0;
            QuoteQuantity = data.TryGetProperty("cumExecValue", out var ceq) && decimal.TryParse(ceq.GetString(), out var ceqValue) ? ceqValue : 0;
            CumulativeQuoteQuantity = data.TryGetProperty("cumExecValue", out var cev_cq) && decimal.TryParse(cev_cq.GetString(), out var ceValue_cq) ? ceValue_cq : 0;
=======
            CumulativeExecutedValue = data.TryGetProperty("cumExecValue", out var cev) && decimal.TryParse(cev.GetString(), out var ceValue) ? ceValue : 0;
            QuoteQuantity = CumulativeExecutedValue;
            CumulativeQuoteQuantity = CumulativeExecutedValue;
>>>>>>> REPLACE
```

## 3. Обоснование

Это изменение должно окончательно решить обе проблемы:
1.  Ошибка компиляции `CS0128` будет устранена.
2.  `CumulativeQuoteQuantity` будет получать фактическое значение из `cumExecValue`, что позволит `ArbitrageTrader` корректно передать выручку в Leg 2.

## 4. Оценка рисков

-   **Риск:** Низкий.

## 5. План тестирования

1.  Утвердить и применить изменение.
2.  Запустить сборку проекта.
3.  **Ожидаемый результат:** Проект успешно компилируется.
4.  Запустить приложение.
5.  **Ожидаемый результат выполнения:**
    *   В логе `other.txt` `CumulativeQuoteQuantity` будет иметь ненулевое значение.
    *   Leg 2 запустится с правильной суммой.
    *   Ошибки `Insufficient balance` исчезнут.

## 6. План отката

-   Восстановить предыдущую версию файла `trader/src/Exchanges/Bybit/BybitLowLatencyWs.cs`.