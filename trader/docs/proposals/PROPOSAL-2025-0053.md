# PROPOSAL-2025-0053: Correct Final Sell Quantity in ReverseArbitrageTrader

## 1. Диагностика

После успешного исправления Leg 1, Leg 2 падает на последнем шаге: попытке продать актив на Gate.io для ребалансировки. Логи показывают ошибку `BALANCE_NOT_ENOUGH`.

Анализ кода `ReverseArbitrageTrader.cs` показал, что для этой продажи используется количество актива, только что купленное на Bybit. Это нарушает логику, описанную в `main_process_flow.md` (Шаг 6), которая требует использовать **изначальный** баланс Gate.io, сохраненный в `ArbitrageCycleState` перед началом всего цикла.

## 2. Предлагаемое изменение

Это изменение заменяет источник данных для объема продажи. Вместо количества, полученного после покупки на Bybit, будет использоваться `_state.InitialGateIoBaseAssetBalance`.

### `trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs`

```diff
<<<<<<< SEARCH
:start_line:167
-------
                var sellQuantity = Math.Truncate(actualQuantity * factor) / factor;
                FileLogger.LogOther($"[Y5] Immediately selling {sellQuantity} on GateIoExchange (original from Bybit Leg 2: {actualQuantity}).");
=======
                var sellQuantity = Math.Truncate(_state.InitialGateIoBaseAssetBalance * factor) / factor;
                FileLogger.LogOther($"[Y5] Immediately selling {sellQuantity} on GateIoExchange (original from STATE: {_state.InitialGateIoBaseAssetBalance}).");
>>>>>>> REPLACE
```

## 3. Обоснование

Это исправление приводит код в полное соответствие с целевой логикой из `main_process_flow.md`. Использование начального баланса для ребалансировки гарантирует, что мы продаем ровно то количество, которое было на бирже изначально, что должно устранить ошибку `BALANCE_NOT_ENOUGH` и завершить цикл корректно.

## 4. Оценка рисков

-   **Риск:** Низкий. Изменение локализовано и исправляет явную логическую ошибку.

## 5. План тестирования

1.  Утвердить и применить изменение.
2.  Запустить сборку и выполнение.
3.  **Ожидаемый результат:**
    *   Весь цикл (Leg 1 и Leg 2) завершается без ошибок.
    *   В логе `other.txt` для Leg 2 появляется запись `[Y5] Immediately selling ... (original from STATE: ...)`
    *   Ошибка `BALANCE_NOT_ENOUGH` на Gate.io в `websocket.txt` больше не появляется.

## 6. План отката

-   Восстановить предыдущую версию файла `trader/src/Exchanges/Bybit/ReverseArbitrageTrader.cs`.