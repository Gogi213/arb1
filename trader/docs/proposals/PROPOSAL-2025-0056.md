# PROPOSAL-2025-0056: Использование точного объема покупки для продажи в Leg 1

## Диагностика

Анализ логов после исправления `PROPOSAL-2025-0055` показал, что `Leg 2` теперь работает корректно, используя точный объем. Однако, в `Leg 1` (Gate.io -> Bybit) обнаружилась аналогичная логическая ошибка.

`ArbitrageTrader` для определения количества продажи на Bybit использует значение, полученное из события обновления баланса на Gate.io, которое затем округляется:
- `[04:31:55.906] [Arbitrage] Balance update received. Actual available quantity: 21,50193`
- `[04:31:55.908] [Arbitrage] ... rounded sell quantity: 22`

В то же время, фактическое количество, купленное на Gate.io, составило `21,48`. В результате на Bybit продается больше (`22 H`), чем было куплено в рамках цикла (`21.48 H`), что нарушает чистоту арбитражной операции и использует "пыль" на балансе Bybit.

## Предлагаемое изменение

Необходимо исправить `ArbitrageTrader.cs`, чтобы для ордера на продажу на Bybit использовалось точное количество, полученное из исполненного ордера на покупку на Gate.io, а не значение из обновления баланса.

**Файл:** `trader/src/Core/ArbitrageTrader.cs`
```diff
--- a/trader/src/Core/ArbitrageTrader.cs
+++ b/trader/src/Core/ArbitrageTrader.cs
@@ -132,9 +132,9 @@
 
                 // Round the quantity according to the sell exchange's rules
                 // Use the precise quantity from the balance update
-               var sellQuantity = Math.Round(actualQuantity, _sellBasePrecision);
-               FileLogger.LogOther($"[Arbitrage] Original buy quantity from balance: {actualQuantity}, rounded sell quantity: {sellQuantity}");
+               var sellQuantity = Math.Round(filledOrder.Quantity, _sellBasePrecision);
+               FileLogger.LogOther($"[Arbitrage] Original buy quantity from order: {filledOrder.Quantity}, rounded sell quantity: {sellQuantity}");
 
                 var t2 = DateTime.UtcNow;
                 var sellOrderId = await _sellExchange.PlaceOrderAsync(
```

## Обоснование

1.  **Корректность:** Это изменение обеспечивает продажу на Bybit точного количества, купленного на Gate.io, что соответствует основной цели арбитражного цикла.
2.  **Симметрия:** Логика `Leg 1` становится симметричной логике `Leg 2`, где уже используется точное значение.
3.  **Надежность:** Устраняется зависимость от асинхронного и потенциально нестабильного механизма обновления баланса для определения ключевого параметра ордера.

## Оценка рисков

-   **Низкий:** Изменение затрагивает только источник данных для переменной `sellQuantity` в одном месте. Это исправляет явную логическую ошибку и не должно вызывать побочных эффектов.

## План тестирования

1.  Запустить приложение после применения изменений.
2.  Проверить логи `other.txt`, чтобы убедиться, что:
    -   Сообщение `[Arbitrage] Original buy quantity from order: ...` содержит точное количество из ордера.
    -   Количество, отправленное на продажу на Bybit, соответствует количеству, купленному на Gate.io.

## План отката

1.  Отменить изменение в файле `trader/src/Core/ArbitrageTrader.cs` с помощью `git restore`.
2.  Пересобрать проект.