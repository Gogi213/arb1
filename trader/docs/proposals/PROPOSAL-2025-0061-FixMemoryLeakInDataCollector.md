# PROPOSAL-2025-0061: Устранить утечку памяти в сборщике данных

## Диагностика
В `ParquetDataWriter` обнаружена утечка памяти. Словари `spreadBuffers` и `tradeBuffers` бесконтрольно растут. При смене часа или заполнении батча данные из буферов-списков записываются на диск, после чего списки очищаются (`.Clear()`), но сами записи (ключ-значение) из родительских словарей не удаляются. Это приводит к тому, что словари вечно хранят пустые списки для всех когда-либо обработанных часов и символов, что вызывает переполнение памяти (OOM).

## Предлагаемое изменение
После принудительной записи всех буферов на диск (при смене часа) необходимо полностью очищать сами словари, а не только их содержимое.

**Файл для изменения:** `collections/src/SpreadAggregator.Infrastructure/Services/ParquetDataWriter.cs`

```diff
<<<<<<< SEARCH
:start_line:179
-------
                        await FlushAllBuffersAsync(spreadBuffers, tradeBuffers);
                    }
                    lastHour = currentHour;
=======
                        await FlushAllBuffersAsync(spreadBuffers, tradeBuffers);
                        spreadBuffers.Clear();
                        tradeBuffers.Clear();
                    }
                    lastHour = currentHour;
>>>>>>> REPLACE
```

## Обоснование
Это изменение гарантирует, что после того, как данные за определенный период записаны, все связанные с ними структуры в памяти (ключи и пустые списки в словарях) будут удалены сборщиком мусора. Это предотвратит бесконечный рост словарей и устранит утечку памяти.

## Оценка рисков
Риск минимален. Изменение исправляет очевидную логическую ошибку и не влияет на механизм записи данных, а только на управление памятью после записи.

## План тестирования
1.  Применить изменения.
2.  Запустить `SpreadAggregator.Presentation` и оставить работать на длительное время (несколько часов), чтобы приложение пересекло границы нескольких часов.
3.  Наблюдать за потреблением памяти процессом. Оно должно оставаться стабильным и не должно линейно расти с течением времени.

## План отката
Отменить изменения в файле `ParquetDataWriter.cs`.