# PROPOSAL-2025-0062: Заменить Parquet на CSV для минимизации потребления памяти

## Диагностика
Текущая реализация с `ParquetDataWriter` требует буферизации данных в памяти перед записью на диск. Это приводит к высокому потреблению RAM и риску Out-Of-Memory (OOM) на системах с ограниченными ресурсами. Формат Parquet не поддерживает эффективную дозапись (append), что и делает буферизацию необходимой.

## Предлагаемое изменение
Полностью отказаться от Parquet и буферизации в памяти в пользу простого формата CSV, который позволяет мгновенно дозаписывать каждую запись в файл.

### 1. Создать новый `CsvDataWriter`
Создать новый файл `collections/src/SpreadAggregator.Infrastructure/Services/CsvDataWriter.cs`, который будет реализовывать `IDataWriter` и дозаписывать данные в `.csv` файлы.

### 2. Заменить реализацию `IDataWriter`
В файле `collections/src/SpreadAggregator.Presentation/Program.cs` заменить регистрацию `ParquetDataWriter` на `CsvDataWriter`.

### 3. Удалить старый `ParquetDataWriter`
Удалить файл `collections/src/SpreadAggregator.Infrastructure/Services/ParquetDataWriter.cs`, так как он больше не будет использоваться.

## Обоснование
Этот подход радикально решает проблему потребления памяти. Вместо накопления тысяч записей в RAM, каждая запись будет немедленно записана на диск. Это делает приложение чрезвычайно легковесным по отношению к памяти, что идеально подходит для систем с ограниченными ресурсами. Хотя CSV менее эффективен для хранения и анализа, чем Parquet, на данном этапе стабильность и низкое потребление ресурсов являются более высоким приоритетом.

## Оценка рисков
Низкий. Изменение затрагивает только механизм персистенции данных и инкапсулировано в реализации `IDataWriter`. Основная логика приложения не меняется.

## План тестирования
1.  Применить изменения.
2.  Запустить `SpreadAggregator.Presentation`.
3.  Убедиться, что в директории `data/market_data` создаются `.csv` файлы.
4.  Проверить, что данные в этих файлах соответствуют формату CSV и корректны.
5.  Оставить приложение работать на длительное время и убедиться, что потребление памяти остается низким и стабильным.

## План отката
1.  Вернуть `ParquetDataWriter` в `Program.cs`.
2.  Удалить `CsvDataWriter.cs`.
3.  Восстановить `ParquetDataWriter.cs`.