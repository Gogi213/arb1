# PROPOSAL-2025-0063 (Final): Устранение фантомных спредов с помощью `tolerance`

**Дата:** 2025-11-04
**Статус:** Финальная версия

## 1. Компактная диагностика

Предыдущие попытки исправления выявили более глубокую проблему:
1.  `strategy="nearest"` было неверно, так как "заглядывало в будущее".
2.  `strategy="backward"` было логически верным, но приводило к еще большим расхождениям. Причина в том, что во время пауз в одном из потоков данных, `backward` сопоставлял текущую цену с **очень устаревшим** значением из другого потока, создавая огромные искусственные спреды.

**Финальное решение** — использовать `strategy="backward"` в сочетании с параметром `tolerance`. Это позволит искать предшествующее значение, но только в пределах заданного временного окна (например, 2 секунды). Если значение не найдено в этом окне, будет возвращен `null`, который затем безопасно отфильтруется.

## 2. Предлагаемое изменение

Внести изменение в файл `charts/server.py`, добавив параметр `tolerance` в вызов `join_asof`.

**Файл:** `charts/server.py`

```diff
--- a/charts/server.py
+++ b/charts/server.py
@@ -71,7 +71,8 @@
     df_b = df_b.with_columns(clean_price_polars(pl.col("BestBid")).alias("bid_b")).sort("timestamp")
 
     # Используем 'backward' для предотвращения "заглядывания в будущее".
-    merged_df = df_a.join_asof(df_b, on="timestamp", strategy="backward")
+    # Добавляем 'tolerance', чтобы не использовать слишком старые данные.
+    merged_df = df_a.join_asof(df_b, on="timestamp", strategy="backward", tolerance="2s")
     if merged_df.height == 0:
         return None
 

```

## 3. Обоснование

Этот подход является наиболее надежным:
1.  **`strategy="backward"`**: Исключает "заглядывание в будущее".
2.  **`tolerance="2s"`**: Предотвращает использование устаревших данных, которые являются причиной больших фантомных спредов.
3.  **Последующая фильтрация `null`**: Гарантирует стабильность, удаляя точки, где синхронизация в пределах `tolerance` не удалась.

Это решение должно окончательно устранить проблему и привести визуализацию в соответствие с реальностью.

## 4. Оценка рисков

Риск минимален. Это стандартный и рекомендуемый способ для синхронизации асинхронных временных рядов. В худшем случае, если потоки сильно рассинхронизированы, на графике будет меньше точек, но все они будут корректными.

## 5. План тестирования

1.  Применить предлагаемое изменение.
2.  Перезапустить сервер `uvicorn`.
3.  Обновить страницу `charts/index.html`.
4.  Убедиться, что большие аномальные спреды исчезли, и график выглядит гладким и реалистичным.

## 6. План отката

Вернуть `charts/server.py` к состоянию до этого изменения.