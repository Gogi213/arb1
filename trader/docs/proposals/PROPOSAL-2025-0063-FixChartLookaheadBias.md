# PROPOSAL-2025-0063: Устранение ошибки "заглядывания в будущее" (Look-ahead Bias) в сервере `charts`

**Дата:** 2025-11-04

## 1. Компактная диагностика

Сервер визуализации `charts/server.py` использует функцию `join_asof` из библиотеки Polars с параметром `strategy="nearest"`. Это приводит к фундаментальной логической ошибке "заглядывания в будущее", когда цена из одного потока данных сопоставляется с ценой из другого потока, которая еще не произошла. В результате на графиках появляются искусственные, "фантомные" спреды, которые не существуют в реальности.

В то же время, основной аналитический скрипт `analyzer/run_all_ultra.py` использует ту же функцию с корректной стратегией по умолчанию (`'backward'`), которая сопоставляет данные только с уже произошедшими событиями. Это расхождение в логике является причиной несоответствия между аналитикой и визуализацией.

## 2. Предлагаемое изменение

Изменить одну строку в файле `charts/server.py`, чтобы заменить некорректную стратегию объединения данных на корректную.

**Файл:** `charts/server.py`

```diff
--- a/charts/server.py
+++ b/charts/server.py
@@ -69,7 +69,7 @@
     df_b = df_b.with_columns(clean_price_polars(pl.col("BestBid")).alias("bid_b")).sort("timestamp")
 
     # Polars asof_join is extremely fast
-    merged_df = df_a.join_asof(df_b, on="timestamp", strategy="nearest")
+    merged_df = df_a.join_asof(df_b, on="timestamp", strategy="backward")
     merged_df = merged_df.drop_nulls()
 
     if merged_df.height == 0:

```

## 3. Обоснование

Замена `strategy="nearest"` на `strategy="backward"` (или просто удаление параметра, так как `'backward'` является значением по умолчанию) приведет логику визуализации в соответствие с логикой основного аналитического скрипта. Это устранит ошибку "заглядывания в будущее" и гарантирует, что графики будут отображать только те спреды, которые могли быть реально зафиксированы в данный момент времени.

## 4. Оценка рисков

Риск минимален. Изменение исправляет очевидную логическую ошибку. Единственным последствием будет исчезновение ложных арбитражных возможностей с графиков, что является желаемым результатом.

## 5. План тестирования

1.  Применить предлагаемое изменение к файлу `charts/server.py`.
2.  Перезапустить сервер `uvicorn`.
3.  Обновить страницу `charts/index.html` в браузере.
4.  Убедиться, что ранее наблюдавшиеся аномальные расхождения спреда исчезли или значительно уменьшились, и теперь графики соответствуют ожиданиям, основанным на анализе.

## 6. План отката

В случае непредвиденных проблем, откатить изменение в файле `charts/server.py`, вернув `strategy="nearest"`:

```python
merged_df = df_a.join_asof(df_b, on="timestamp", strategy="nearest")