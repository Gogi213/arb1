# –ö–†–ê–¢–ö–ê–Ø –°–í–û–î–ö–ê –ê–£–î–ò–¢–ê - ARB1 PROJECT

**–î–∞—Ç–∞:** 2025-11-08
**–°—Ç–∞—Ç—É—Å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

---

## –ì–õ–ê–í–ù–´–ï –ù–ê–•–û–î–ö–ò

### üî¥ –¢–û–ü-5 –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –ü–†–û–ë–õ–ï–ú

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª | –†–∏—Å–∫ | –†–µ—à–µ–Ω–∏–µ |
|---|----------|------|------|---------|
| 1 | **Unbounded Channels** | Program.cs:72-73 | OOM –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω | BoundedChannelOptions(10000) |
| 2 | **RollingWindow 1 —á–∞—Å** | –û–±–∞ –ø—Ä–æ–µ–∫—Ç–∞ | 354 MB √ó 2 = 708 MB | –£–º–µ–Ω—å—à–∏—Ç—å –¥–æ 5 –º–∏–Ω—É—Ç ‚Üí 36 MB |
| 3 | **Event handlers leak** | ExchangeClientBase.cs:201 | –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ | –î–æ–±–∞–≤–∏—Ç—å -= –ø—Ä–∏ dispose |
| 4 | **–ü–∞—Ä—Å–∏–Ω–≥ 8x –∫–æ–ø–∏–π** | ParquetDataWriter.cs:75 | 614 MB –±—É—Ñ–µ—Ä–æ–≤ | Streaming —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è |
| 5 | **_allSymbolInfo —Ä–æ—Å—Ç** | OrchestrationService.cs:27 | –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–æ—Å—Ç | –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ |

---

## –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### ‚ùå –ò–ó–ë–´–¢–û–ß–ù–û–°–¢–¨

1. **RollingWindow —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –î–í–ê–ñ–î–´**
   - Collections: 86 —Å—Ç—Ä–æ–∫
   - Charts: 88 —Å—Ç—Ä–æ–∫
   - –ò—Ç–æ–≥–æ: 174 LOC –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è + 708 MB –ø–∞–º—è—Ç–∏

2. **Parquet I/O —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –î–í–ê–ñ–î–´**
   - Collections: 271 —Å—Ç—Ä–æ–∫–∞ (–∑–∞–ø–∏—Å—å)
   - Charts: 120+ —Å—Ç—Ä–æ–∫ (—á—Ç–µ–Ω–∏–µ)

3. **–î–í–ê WebSocket —Å–µ—Ä–≤–µ—Ä–∞**
   - Collections:8181 ‚Üí Charts:8002 ‚Üí Clients
   - Latency overhead: 6.6-26.5 ms

4. **Clean Architecture 4-—Å–ª–æ—è –¥–ª—è 1120 LOC**
   - Domain ‚Üí Application ‚Üí Infrastructure ‚Üí Presentation
   - 8 –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –¥–ª—è 10 –∫–ª–∞—Å—Å–æ–≤
   - 200+ LOC boilerplate

---

## –¶–ò–§–†–´

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

```
–ü—Ä–æ–µ–∫—Ç–æ–≤:     2 (C# + Python)
–ü—Ä–æ—Ü–µ—Å—Å–æ–≤:    2
–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:   1120
–ü–∞–º—è—Ç—å:       708 MB (worst case)
–õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:  26.5 ms
–ö–∞–Ω–∞–ª–æ–≤:      2 (unbounded)
–£—Ç–µ—á–µ–∫:       10 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

```
–ü—Ä–æ–µ–∫—Ç–æ–≤:     1 (C#)              ‚¨áÔ∏è -50%
–ü—Ä–æ—Ü–µ—Å—Å–æ–≤:    1                   ‚¨áÔ∏è -50%
–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:   600-700             ‚¨áÔ∏è -40%
–ü–∞–º—è—Ç—å:       150 MB              ‚¨áÔ∏è -79%
–õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:  20 ms               ‚¨áÔ∏è -25%
–ö–∞–Ω–∞–ª–æ–≤:      1-2 (bounded)       ‚úÖ Safe
–£—Ç–µ—á–µ–∫:       0                   ‚úÖ Fixed
```

---

## –ß–¢–û –î–ï–õ–ê–¢–¨

### –ù–ï–î–ï–õ–Ø 1 (–ö–†–ò–¢–ò–ß–ù–û)

**–î–µ–Ω—å 1-2:**
```csharp
// 1. Bounded Channels
var options = new BoundedChannelOptions(10000)
{ FullMode = BoundedChannelFullMode.DropOldest };
Channel.CreateBounded(options);
```

**–î–µ–Ω—å 3:**
```csharp
// 2. RollingWindow: 1 —á–∞—Å ‚Üí 5 –º–∏–Ω—É—Ç
TimeSpan.FromMinutes(5)  // WAS: FromHours(1)
// –≠–∫–æ–Ω–æ–º–∏—è: 354 MB ‚Üí 36 MB
```

**–î–µ–Ω—å 4:**
```csharp
// 3. Event handlers cleanup
result.Data.ConnectionLost -= HandleConnectionLost;
result.Data.ConnectionRestored -= HandleConnectionRestored;
```

**–î–µ–Ω—å 5:**
```csharp
// 4. StopAsync —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
public async Task StopAsync(CancellationToken cancellationToken)
{
    await _orchestrationService.StopAsync(cancellationToken);
    _cleanupTimer?.Dispose();
}
```

**–†–ï–ó–£–õ–¨–¢–ê–¢:** OOM risk ‚Üí ELIMINATED

---

### –ù–ï–î–ï–õ–Ø 2 (–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø)

**–î–µ–Ω—å 1-3: –û–±—ä–µ–¥–∏–Ω–∏—Ç—å Collections + Charts**

```
–î–û:
Collections (C#) ‚îÄ‚îÄWebSocket‚îÄ‚îÄ‚ñ∫ Charts (Python) ‚îÄ‚îÄWebSocket‚îÄ‚îÄ‚ñ∫ Clients
      ‚Üì                              ‚Üì
  RollingWindow                 RollingWindow (–¥—É–±–ª–∏–∫–∞—Ç!)
   (354 MB)                      (354 MB)

–ü–û–°–õ–ï:
SpreadAggregator.Api (C# + Polars.NET) ‚îÄ‚îÄWebSocket‚îÄ‚îÄ‚ñ∫ Clients
              ‚Üì
         RollingWindow
          (36 MB)
```

**–≠–∫–æ–Ω–æ–º–∏—è:**
- –ü–∞–º—è—Ç—å: 708 MB ‚Üí 36 MB (-95%)
- LOC: 1120 ‚Üí 600 (-46%)
- –ü—Ä–æ—Ü–µ—Å—Å–æ–≤: 2 ‚Üí 1 (-50%)

**–î–µ–Ω—å 4-5: –£–ø—Ä–æ—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É**

```
–î–û: Domain ‚Üí Application ‚Üí Infrastructure ‚Üí Presentation (4 —Å–ª–æ—è)
–ü–û–°–õ–ï: Core ‚Üí API (2 —Å–ª–æ—è)

–î–û: 3 Hosted Services
–ü–û–°–õ–ï: 1 DataPipelineService
```

**–†–ï–ó–£–õ–¨–¢–ê–¢:** –ü—Ä–æ—Å—Ç–æ—Ç–∞ + –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

## –ü–†–ò–û–†–ò–¢–ò–ó–ê–¶–ò–Ø

### üî¥ MUST DO (—Å–µ–π—á–∞—Å):
1. ‚úÖ Bounded channels
2. ‚úÖ RollingWindow 5 –º–∏–Ω—É—Ç
3. ‚úÖ Event handlers cleanup
4. ‚úÖ StopAsync —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**Effort:** 2 –¥–Ω—è
**Impact:** OOM prevention

---

### üü† SHOULD DO (—Å–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è):
5. ‚úÖ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç—ã
6. ‚úÖ –£–ø—Ä–æ—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
7. ‚úÖ –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–Ω—è–º

**Effort:** 1 –Ω–µ–¥–µ–ª—è
**Impact:** -79% –ø–∞–º—è—Ç–∏, -40% –∫–æ–¥–∞

---

### üü° COULD DO (–±—É–¥—É—â–µ–µ):
8. ‚ö™ TimescaleDB –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
9. ‚ö™ Monitoring/alerting
10. ‚ö™ Horizontal scaling

**Effort:** 2+ –Ω–µ–¥–µ–ª—å
**Impact:** Scalability

---

## –§–ê–ô–õ–´ –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (—Å–µ–π—á–∞—Å):

1. **collections/src/SpreadAggregator.Presentation/Program.cs**
   - –°—Ç—Ä–æ–∫–∏ 72-73: Bounded channels
   - –°—Ç—Ä–æ–∫–∏ 139-169: StopAsync —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

2. **collections/src/SpreadAggregator.Application/Services/OrchestrationService.cs**
   - –°—Ç—Ä–æ–∫–∏ 27, 84: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è _allSymbolInfo
   - –°—Ç—Ä–æ–∫–∏ 114-162: Event handlers cleanup
   - –°—Ç—Ä–æ–∫–∏ 168-170: Await tasks

3. **collections/src/SpreadAggregator.Application/Services/RollingWindowService.cs**
   - –°—Ç—Ä–æ–∫–∏ 16: IDisposable
   - –°—Ç—Ä–æ–∫–∞ 21: Timer dispose
   - Window size ‚Üí 5 –º–∏–Ω—É—Ç

4. **collections/src/SpreadAggregator.Infrastructure/Services/Exchanges/Base/ExchangeClientBase.cs**
   - –°—Ç—Ä–æ–∫–∏ 201-203: Event -= –ø—Ä–∏ dispose

5. **charts/server.py**
   - –°—Ç—Ä–æ–∫–∏ 60: RollingWindow 5 –º–∏–Ω—É—Ç
   - –°—Ç—Ä–æ–∫–∏ 204-208: Task cancel –≤ lifespan
   - –°—Ç—Ä–æ–∫–∏ 176-177: –í–∫–ª—é—á–∏—Ç—å ping/pong

---

## ROI –ê–ù–ê–õ–ò–ó

### –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏:

| –ó–∞–¥–∞—á–∞ | –í—Ä–µ–º—è | –†–∏—Å–∫ |
|--------|-------|------|
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | 2 –¥–Ω—è | –ù–∏–∑–∫–∏–π |
| –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤ | 1 –Ω–µ–¥–µ–ª—è | –°—Ä–µ–¥–Ω–∏–π |
| –£–ø—Ä–æ—â–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã | 3 –¥–Ω—è | –ù–∏–∑–∫–∏–π |
| **–ò–¢–û–ì–û** | **2 –Ω–µ–¥–µ–ª–∏** | **–ù–∏–∑–∫–∏–π** |

### –í–æ–∑–≤—Ä–∞—Ç:

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| –ü–∞–º—è—Ç—å | 708 MB | 150 MB | **-79%** |
| –ö–æ–¥ | 1120 LOC | 600 LOC | **-46%** |
| –ü—Ä–æ—Ü–µ—Å—Å–æ–≤ | 2 | 1 | **-50%** |
| Latency | 26ms | 20ms | **-23%** |
| –°–ª–æ–∂–Ω–æ—Å—Ç—å | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è | **-50%** |
| OOM —Ä–∏—Å–∫ | 100% | 0% | **‚úÖ SOLVED** |

**ROI = –û–ß–ï–ù–¨ –í–´–°–û–ö–ò–ô**

---

## CONTACTS

**–î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã:**
- [OOM_–∞–Ω–∞–ª–∏–∑.md](./OOM_–∞–Ω–∞–ª–∏–∑.md) - –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º —Å –ø–∞–º—è—Ç—å—é
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π_–∞—É–¥–∏—Ç.md](./–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π_–∞—É–¥–∏—Ç.md) - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ü—Ä–æ—á–∏—Ç–∞—Ç—å –æ–±–∞ –æ—Ç—á–µ—Ç–∞
2. –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
3. –ù–∞—á–∞—Ç—å —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö (2 –¥–Ω—è)
4. –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É (1 –Ω–µ–¥–µ–ª—è)

---

**–°–¢–ê–¢–£–°: –ì–û–¢–û–í –ö –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ**
